import{getContext as e,store as t}from"@wordpress/interactivity";const n="skip-speech",s=(e,t)=>{try{return window.localStorage.getItem(e)||t}catch(e){return t}},r=()=>document.documentElement.lang||"en",i=()=>document.querySelector('[data-wp-interactive="mosne-text-to-speech-block"]'),c=()=>document.querySelector("main"),o={isPlaying:!1,currentVoice:null,preferredVoice:s(`mosne-tts-lang-${r()}`,null),utterance:null,voices:[],currentSpeed:s((x=r(),`mosne-tts-speed-${x}`),1),currentPitch:s((e=>`mosne-tts-pitch-${e}`)(r()),1),selectedTextRange:{hasSelection:!1},currentChunk:0,textChunks:[],isProcessingChunks:!1,currentHighlightedNode:null,nodePositions:new Map,currentSelection:null,pausedAt:null,browserType:(()=>{const e=window.navigator.userAgent;return-1!==e.indexOf("Firefox")?"firefox":-1!==e.indexOf("Edge")||-1!==e.indexOf("Edg")?"edge":-1!==e.indexOf("Safari")&&-1===e.indexOf("Chrome")?"safari":-1!==e.indexOf("Chrome")?"chrome":"other"})(),safariKeepAliveTimer:null},a=()=>new Promise(e=>{const t=()=>{window.speechSynthesis.speaking||window.speechSynthesis.pending?setTimeout(t,100):e()};t()}),l=e=>{"safari"===e.browserType&&(e.safariKeepAliveTimer&&clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=setInterval(()=>{e.isPlaying&&window.speechSynthesis.speaking?(window.speechSynthesis.pause(),window.speechSynthesis.resume()):(clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=null)},1e4))},h=e=>{if(e.currentSelection){try{e.currentSelection.removeAllRanges()}catch(e){console.warn("Error clearing highlights:",e)}e.currentSelection=null}e.currentHighlightedNode=null},u=(e,t)=>{if("safari"!==e.browserType)return null;const n=15*e.currentSpeed;let s=0;const r=setInterval(()=>{e.isPlaying?(d(e,{charIndex:s,charLength:1},t),s+=Math.ceil(250*n/1e3)):clearInterval(r)},250);return r},d=(e,t)=>{const s=c();if(s)try{let r=t.charIndex;if(e.currentChunk>0)for(let t=0;t<e.currentChunk;t++)r+=e.textChunks[t].length+1;if(e.selectedTextRange?.hasSelection);else{const t=i(),c=(t?.dataset.excludeClass||n).split(/\s+/);0===e.nodePositions.size&&p(e,s,c);let o=null,a={node:null,distance:Number.MAX_SAFE_INTEGER};const l=Array.from(e.nodePositions.keys()).sort((e,t)=>e-t);for(let t=0;t<l.length;t++){const n=l[t],s=e.nodePositions.get(n);if(n<=r&&r<n+s.length){o=s.node;break}if("firefox"===e.browserType){const e=Math.abs(n-r);e<a.distance&&(a={node:s.node,distance:e})}}!o&&"firefox"===e.browserType&&a.node&&(o=a.node),o&&o!==e.currentHighlightedNode&&o.textContent.trim().length>0&&(h(e),((e,t)=>{if(!t)return null;const n=t.ownerDocument,s=n.defaultView;if(!s)return null;h(e);try{const r=n.createRange();t.nodeType===Node.TEXT_NODE?(r.setStart(t,0),r.setEnd(t,t.length)):r.selectNodeContents(t);const i=s.getSelection();i&&(i.removeAllRanges(),i.addRange(r),e.currentSelection=i,i.rangeCount>0&&(i.getRangeAt(0),i.getRangeAt(0)))}catch(e){console.warn("Error creating highlight:",e)}})(e,o),e.currentHighlightedNode=o,o.nodeType!==Node.TEXT_NODE?o.scrollIntoView({behavior:"smooth",block:"center"}):o.parentNode&&o.parentNode.scrollIntoView({behavior:"smooth",block:"center"}))}}catch(e){console.error("Highlighting error:",e)}},p=(e,t,n)=>{e.nodePositions.clear();const s=(t,r=0)=>{if(t.classList)for(const e of n)if(e&&t.classList.contains(e))return r;if(t.nodeType===Node.TEXT_NODE){const n=t.textContent;return n.trim().length>0&&(e.nodePositions.set(r,{node:t,length:n.length}),r+=n.length),r}if(t.childNodes&&t.childNodes.length>0)for(const e of t.childNodes)r=s(e,r);return r};s(t)},g=(e,t)=>{const n=e.textChunks[e.currentChunk],s=new window.SpeechSynthesisUtterance(n);if(s.lang=r(),s.rate=e.currentSpeed,s.pitch=e.currentPitch,e.currentVoice){const t=e.voices.find(t=>t.voiceURI===e.currentVoice.voiceURI);s.voice=t}w(e,s,n,t),e.utterance=s},w=(e,t,n,s)=>{"safari"===e.browserType?(t.onboundary=s=>{t._lastCharIndex=s.charIndex||0,d(e,s,n)},t._safariTimerId=u(e,n)):t.onboundary=s=>{t._lastCharIndex=s.charIndex||0;const r=void 0!==t._contentOffset?{...s,charIndex:(s.charIndex||0)+t._contentOffset}:s;d(e,r,n)},t.onend=()=>{t._safariTimerId&&clearInterval(t._safariTimerId),e.currentChunk<e.textChunks.length-1?(e.currentChunk++,g(e,s),setTimeout(()=>{e.isPlaying&&e.utterance&&window.speechSynthesis.speak(e.utterance)},50)):(s&&(s.isPlaying=!1),e.isPlaying=!1,h(e))},t.onerror=t=>{console.error("Speech synthesis error:",t),"interrupted"===t.error&&(speechSynthesis.cancel(),f(e))}},f=e=>{h(e),e.isPlaying=!1,e.currentChunk=0,e.textChunks=[],e.currentHighlightedNode=null,e.selectedTextRange={hasSelection:!1}},y=async e=>{"safari"===e.browserType&&(window.speechSynthesis.speak(new SpeechSynthesisUtterance("")),window.speechSynthesis.cancel());const t=window.speechSynthesis.getVoices();if(!t?.length)return void setTimeout(()=>y(e),100);const n=r(),s=t.filter(e=>e.lang.startsWith(n));if(e.voices=s.length>0?s:t,e.currentVoice=e.voices[0],e.preferredVoice){const t=e.voices.find(t=>t.voiceURI===e.preferredVoice);t&&(e.currentVoice=t)}setTimeout(()=>g(e),50)},m=e=>{const t=c(),s=t?.ownerDocument.defaultView,r=s?s.getSelection():null;let o="";if(r&&r.toString().trim().length>0)o=r.toString(),e.selectedTextRange={text:o,hasSelection:!0};else{let s=t?.cloneNode(!0);if(s){const r=i(),c=r?.dataset.excludeClass||n;c.split(/\s+/).forEach(e=>{e&&s.querySelectorAll(`.${e}`).forEach(e=>{e.remove()})}),o=s.textContent,s=null,t&&p(e,t,c.split(/\s+/))}e.selectedTextRange={hasSelection:!1}}return e.textChunks=S(o,200),e.currentChunk=0,e.textChunks.length>0?e.textChunks[0]:""},S=(e,t)=>{if(!e||""===e.trim())return[""];const n=e.trim().split(/\s+/),s=[];for(let e=0;e<n.length;e+=t){const r=n.slice(e,e+t).join(" ");s.push(r)}return s},{state:v}=t("mosne-text-to-speech-block",{state:o,actions:{checkSynthesisReady:()=>a(),setupSafariKeepAlive:()=>l(v),buildNodePositionsMap:()=>p(v),handleBoundaryEvent:()=>d(v),setupSafariHighlighting:()=>u(v),clearHighlights:()=>h(v),loadVoices:()=>y(v),changeVoice:t=>((t,n)=>{window.speechSynthesis.cancel();const s=e();s&&(s.isPlaying=!1);const r=t.voices.find(e=>e.voiceURI===n.target.value);r&&(t.currentVoice=r,window.localStorage.setItem("mosne-tts-lang-"+document.documentElement.lang,r.voiceURI))})(v,t),createUtterance:()=>g(v),setupUtteranceEvents:()=>w(v),handleUtteranceEnd:()=>f(v),Play:()=>(async t=>{const s=e();if(s&&(s.isPlaying=!0),t.isPlaying=!0,"firefox"===t.browserType&&t.pausedAt){const e=t.pausedAt.text.substring(t.pausedAt.charIndex);t.currentChunk=t.pausedAt.chunk;const s=new window.SpeechSynthesisUtterance(e);if(s.lang=r(),s.rate=t.currentSpeed,s.pitch=t.currentPitch,s._lastCharIndex=0,s._contentOffset=t.pausedAt.contentPosition,t.currentVoice){const e=t.voices.find(e=>e.voiceURI===t.currentVoice.voiceURI);s.voice=e}return s.onboundary=e=>{s._lastCharIndex=e.charIndex||0;const r=(e.charIndex||0)+t.pausedAt.contentPosition,o={...e,charIndex:r,charLength:e.charLength||1},a=c();if(a){const e=i(),s=e?.dataset.excludeClass||n;0===t.nodePositions.size&&p(t,a,s.split(/\s+/)),d(t,o,t.pausedAt.fullText||t.pausedAt.text)}},s.onend=()=>f(t),t.utterance=s,window.speechSynthesis.speak(t.utterance),"safari"===t.browserType&&l(t),void(t.pausedAt=null)}0!==t.textChunks.length&&0!==t.currentChunk||(m(t),g(t,s));try{if(window.speechSynthesis.paused)return void window.speechSynthesis.resume()}catch(e){console.warn("Resume failed, recreating speech:",e),g(t,s)}if(("chrome"===t.browserType||"edge"===t.browserType)&&window.speechSynthesis.speaking)return window.speechSynthesis.cancel(),void setTimeout(()=>{t.utterance&&window.speechSynthesis.speak(t.utterance)},50);t.utterance&&(window.speechSynthesis.speak(t.utterance),"safari"===t.browserType&&l(t))})(v),Pause:()=>(async t=>{const n=e();if(n&&(n.isPlaying=!1),t.isPlaying=!1,h(t),"firefox"===t.browserType){if(window.speechSynthesis.speaking){const e=t.textChunks.join(" ");t.pausedAt={text:t.utterance.text,charIndex:t.utterance._lastCharIndex||0,chunk:t.currentChunk,contentPosition:t.utterance._lastCharIndex+(t.currentChunk>0?t.textChunks.slice(0,t.currentChunk).reduce((e,t)=>e+t.length,0):0),fullText:e},window.speechSynthesis.cancel()}}else if("safari"===t.browserType){if(window.speechSynthesis.speaking){const e=t.textChunks.join(" ");t.pausedAt={text:t.utterance.text,charIndex:t.utterance._lastCharIndex||0,chunk:t.currentChunk,contentPosition:t.utterance._lastCharIndex+(t.currentChunk>0?t.textChunks.slice(0,t.currentChunk).reduce((e,t)=>e+t.length,0):0),fullText:e},t.utterance._safariTimerId&&clearInterval(t.utterance._safariTimerId),t.safariKeepAliveTimer&&(clearInterval(t.safariKeepAliveTimer),t.safariKeepAliveTimer=null),window.speechSynthesis.cancel()}}else window.speechSynthesis.speaking&&!window.speechSynthesis.paused&&window.speechSynthesis.pause()})(v),Restart:()=>(t=>{const n=e();n&&(n.isPlaying=!1),t.isPlaying=!1,"safari"===t.browserType&&(t.utterance&&t.utterance._safariTimerId&&clearInterval(t.utterance._safariTimerId),t.safariKeepAliveTimer&&(clearInterval(t.safariKeepAliveTimer),t.safariKeepAliveTimer=null)),window.speechSynthesis.cancel(),t.currentChunk=0,t.textChunks=[],h(t)})(v),changeSpeed:t=>(async(t,n)=>{window.speechSynthesis.cancel();const s=e();s&&(s.isPlaying=!1),t.currentSpeed=n.target.value,window.localStorage.setItem("mosne-tts-speed-"+document.documentElement.lang,n.target.value),await a(),g(t,s),s&&!s.isPlaying&&setTimeout(()=>{s.isPlaying=!0,window.speechSynthesis.speak(t.utterance)},50)})(v,t),changePitch:t=>(async(t,n)=>{window.speechSynthesis.cancel();const s=e();s&&(s.isPlaying=!1),t.currentPitch=n.target.value,window.localStorage.setItem("mosne-tts-pitch-"+document.documentElement.lang,n.target.value),await a(),g(t,s),s&&!s.isPlaying&&setTimeout(()=>{s.isPlaying=!0,window.speechSynthesis.speak(t.utterance)},50)})(v,t),toggleSettings:()=>(()=>{const t=e();t&&(t.showSettings=!t.showSettings)})(),getContent:()=>m(v)},callbacks:{init:()=>(e=>{if(!window.speechSynthesis)return void console.warn("Speech synthesis not supported in this browser");window.speechSynthesis.cancel(),(()=>{const e=c(),t=i();if(!e||!t)return;const n=t.dataset.highlightBackground||"#ffeb3b",s=t.dataset.highlightColor||"#000000";e.style.setProperty("--mosne-tts-highlight-bg",n),e.style.setProperty("--mosne-tts-highlight-color",s)})(),y(e),void 0!==window.speechSynthesis.onvoiceschanged&&(window.speechSynthesis.onvoiceschanged=()=>y(e)),window.addEventListener("beforeunload",()=>{window.speechSynthesis.cancel(),"safari"===e.browserType&&(e.utterance&&e.utterance._safariTimerId&&clearInterval(e.utterance._safariTimerId),e.safariKeepAliveTimer&&clearInterval(e.safariKeepAliveTimer))});const t=c();if(t){const s=i(),r=s?.dataset.excludeClass||n;setTimeout(()=>{p(e,t,r.split(/\s+/))},500)}})(v),isSelected:()=>(t=>{const n=e();return n.voice?.voiceURI===t.currentVoice?.voiceURI})(v)}});var x;