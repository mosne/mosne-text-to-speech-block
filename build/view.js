import*as e from"@wordpress/interactivity";var t={d:(e,n)=>{for(var r in n)t.o(n,r)&&!t.o(e,r)&&Object.defineProperty(e,r,{enumerable:!0,get:n[r]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)},n={};t.d(n,{K:()=>u});const r=(f={getContext:()=>e.getContext,store:()=>e.store},w={},t.d(w,f),w),s="skip-speech",i=(e,t)=>{try{return window.localStorage.getItem(e)||t}catch(e){return t}},o=()=>document.documentElement.lang||"en",a=()=>document.querySelector('[data-wp-interactive="mosne-text-to-speech-block"]'),c=()=>document.querySelector("main"),l=()=>{const e=window.navigator.userAgent;return-1!==e.indexOf("Firefox")?"firefox":-1!==e.indexOf("Edge")||-1!==e.indexOf("Edg")?"edge":-1!==e.indexOf("Safari")&&-1===e.indexOf("Chrome")?"safari":-1!==e.indexOf("Chrome")?"chrome":"other"},{state:d,actions:h}=(0,r.store)("mosne-text-to-speech-block",{state:{isPlaying:!1,currentVoice:null,preferredVoice:i((p=o(),`mosne-tts-lang-${p}`),null),utterance:null,voices:[],currentSpeed:i((e=>`mosne-tts-speed-${e}`)(o()),1),currentPitch:i((e=>`mosne-tts-pitch-${e}`)(o()),1),selectedTextRange:{hasSelection:!1},currentChunk:0,textChunks:[],isProcessingChunks:!1,currentHighlightedNode:null,nodePositions:new Map,currentSelection:null,pausedAt:null,browserType:l(),safariKeepAliveTimer:null},actions:{checkSynthesisReady:()=>new Promise((e=>{const t=()=>{window.speechSynthesis.speaking||window.speechSynthesis.pending?setTimeout(t,100):e()};t()})),clearHighlights(){if(d.currentSelection){try{d.currentSelection.removeAllRanges()}catch(e){console.warn("Error clearing highlights:",e)}d.currentSelection=null}d.currentHighlightedNode=null},createHighlightWrapper(e){if(!e)return null;const t=e.ownerDocument,n=t.defaultView;if(!n)return null;h.clearHighlights();try{const r=t.createRange();e.nodeType===Node.TEXT_NODE?(r.setStart(e,0),r.setEnd(e,e.length)):r.selectNodeContents(e);const s=n.getSelection();s&&(s.removeAllRanges(),s.addRange(r),d.currentSelection=s,s.rangeCount>0&&(s.getRangeAt(0),s.getRangeAt(0)))}catch(e){console.warn("Error creating highlight:",e)}},async loadVoices(){"safari"===d.browserType&&(window.speechSynthesis.speak(new SpeechSynthesisUtterance("")),window.speechSynthesis.cancel());const e=window.speechSynthesis.getVoices();if(!e?.length)return void setTimeout((()=>h.loadVoices()),100);const t=o(),n=e.filter((e=>e.lang.startsWith(t)));if(d.voices=n.length>0?n:e,d.currentVoice=d.voices[0],d.preferredVoice){const e=d.voices.find((e=>e.voiceURI===d.preferredVoice));e&&(d.currentVoice=e)}setTimeout((()=>h.createUtterance()),50)},createUtterance(){const e=d.textChunks.length>0?d.textChunks[d.currentChunk]:h.getContent(),t=new window.SpeechSynthesisUtterance(e);if(t.lang=o(),t.rate=d.currentSpeed,t.pitch=d.currentPitch,d.currentVoice){const e=d.voices.find((e=>e.voiceURI===d.currentVoice.voiceURI));t.voice=e}h.setupUtteranceEvents(t,e),d.utterance=t},setupUtteranceEvents(e,t){"safari"===d.browserType?(e.onboundary=n=>{e._lastCharIndex=n.charIndex||0,h.handleBoundaryEvent(n,t)},e._safariTimerId=h.setupSafariHighlighting(t)):e.onboundary=n=>{e._lastCharIndex=n.charIndex||0;const r=void 0!==e._contentOffset?{...n,charIndex:(n.charIndex||0)+e._contentOffset}:n;h.handleBoundaryEvent(r,t)},e.onend=()=>{e._safariTimerId&&clearInterval(e._safariTimerId),h.handleUtteranceEnd()},e.onerror=e=>{console.error("Speech synthesis error:",e),h.handleUtteranceEnd()}},setupSafariHighlighting(e){if("safari"!==d.browserType)return null;const t=15*d.currentSpeed;let n=0;const r=setInterval((()=>{if(!d.isPlaying)return void clearInterval(r);const s={charIndex:n,charLength:1};h.handleBoundaryEvent(s,e),n+=Math.ceil(250*t/1e3),n>=e.length&&clearInterval(r)}),250);return r},setupSafariKeepAlive(){"safari"===d.browserType&&(d.safariKeepAliveTimer&&clearInterval(d.safariKeepAliveTimer),d.safariKeepAliveTimer=setInterval((()=>{d.isPlaying&&window.speechSynthesis.speaking?(window.speechSynthesis.pause(),window.speechSynthesis.resume()):(clearInterval(d.safariKeepAliveTimer),d.safariKeepAliveTimer=null)}),1e4))},async Play(){if((0,r.getContext)().isPlaying=!0,d.isPlaying=!0,"firefox"===d.browserType&&d.pausedAt){const e=d.pausedAt.text.substring(d.pausedAt.charIndex);d.currentChunk=d.pausedAt.chunk;const t=new window.SpeechSynthesisUtterance(e);if(t.lang=o(),t.rate=d.currentSpeed,t.pitch=d.currentPitch,t._lastCharIndex=0,t._contentOffset=d.pausedAt.contentPosition,d.currentVoice){const e=d.voices.find((e=>e.voiceURI===d.currentVoice.voiceURI));t.voice=e}return t.onboundary=e=>{t._lastCharIndex=e.charIndex||0;const n=(e.charIndex||0)+d.pausedAt.contentPosition,r={...e,charIndex:n,charLength:e.charLength||1},i=c();if(i){const e=a(),t=e?.dataset.excludeClass||s;0===d.nodePositions.size&&h.buildNodePositionsMap(i,t.split(/\s+/)),h.handleBoundaryEvent(r,d.pausedAt.fullText||d.pausedAt.text)}},t.onend=()=>h.handleUtteranceEnd(),d.utterance=t,window.speechSynthesis.speak(d.utterance),"safari"===d.browserType&&h.setupSafariKeepAlive(),void(d.pausedAt=null)}0!==d.textChunks.length&&0!==d.currentChunk||(h.getContent(),h.createUtterance());try{if(window.speechSynthesis.paused)return void window.speechSynthesis.resume()}catch(e){console.warn("Resume failed, recreating speech:",e),h.createUtterance()}if(("chrome"===d.browserType||"edge"===d.browserType)&&window.speechSynthesis.speaking)return window.speechSynthesis.cancel(),void setTimeout((()=>{d.utterance&&window.speechSynthesis.speak(d.utterance)}),50);d.utterance&&(window.speechSynthesis.speak(d.utterance),"safari"===d.browserType&&h.setupSafariKeepAlive())},Pause(){if((0,r.getContext)().isPlaying=!1,d.isPlaying=!1,"firefox"===d.browserType){if(window.speechSynthesis.speaking){const e=d.textChunks.join(" ");d.pausedAt={text:d.utterance.text,charIndex:d.utterance._lastCharIndex||0,chunk:d.currentChunk,contentPosition:d.utterance._lastCharIndex+(d.currentChunk>0?d.textChunks.slice(0,d.currentChunk).reduce(((e,t)=>e+t.length),0):0),fullText:e},window.speechSynthesis.cancel()}}else if("safari"===d.browserType){if(window.speechSynthesis.speaking){const e=d.textChunks.join(" ");d.pausedAt={text:d.utterance.text,charIndex:d.utterance._lastCharIndex||0,chunk:d.currentChunk,contentPosition:d.utterance._lastCharIndex+(d.currentChunk>0?d.textChunks.slice(0,d.currentChunk).reduce(((e,t)=>e+t.length),0):0),fullText:e},d.utterance._safariTimerId&&clearInterval(d.utterance._safariTimerId),d.safariKeepAliveTimer&&(clearInterval(d.safariKeepAliveTimer),d.safariKeepAliveTimer=null),window.speechSynthesis.cancel()}}else window.speechSynthesis.speaking&&!window.speechSynthesis.paused&&window.speechSynthesis.pause()},Restart(){(0,r.getContext)().isPlaying=!1,d.isPlaying=!1,"safari"===d.browserType&&(d.utterance&&d.utterance._safariTimerId&&clearInterval(d.utterance._safariTimerId),d.safariKeepAliveTimer&&(clearInterval(d.safariKeepAliveTimer),d.safariKeepAliveTimer=null)),window.speechSynthesis.cancel(),d.currentChunk=0,d.textChunks=[],h.clearHighlights()},changeVoice(e){(0,r.getContext)().isPlaying=!1,window.speechSynthesis.cancel();const t=d.voices.find((t=>t.voiceURI===e.target.value));t&&(d.currentVoice=t,window.localStorage.setItem("mosne-tts-lang-"+document.documentElement.lang,t.voiceURI),setTimeout((()=>{h.updateUtterance()}),50))},async changeSpeed(e){const t=(0,r.getContext)();t.isPlaying=!1,window.speechSynthesis.cancel(),d.currentSpeed=e.target.value,window.localStorage.setItem("mosne-tts-speed-"+document.documentElement.lang,e.target.value),await h.checkSynthesisReady(),h.createUtterance(),t.isPlaying&&setTimeout((()=>{window.speechSynthesis.speak(d.utterance)}),50)},async changePitch(e){const t=(0,r.getContext)();t.isPlaying=!1,window.speechSynthesis.cancel(),d.currentPitch=e.target.value,window.localStorage.setItem("mosne-tts-pitch-"+document.documentElement.lang,e.target.value),await h.checkSynthesisReady(),h.createUtterance(),t.isPlaying&&setTimeout((()=>{window.speechSynthesis.speak(d.utterance)}),50)},toggleSettings(){const e=(0,r.getContext)();e.showSettings=!e.showSettings},getContent(){const e=c(),t=e?.ownerDocument.defaultView,n=t?t.getSelection():null;let r="";if(n&&n.toString().trim().length>0)r=n.toString(),d.selectedTextRange={text:r,hasSelection:!0};else{let t=e?.cloneNode(!0);if(t){const n=a(),i=n?.dataset.excludeClass||s;i.split(/\s+/).forEach((e=>{e&&t.querySelectorAll(`.${e}`).forEach((e=>{e.remove()}))})),r=t.textContent,t=null,e&&h.buildNodePositionsMap(e,i.split(/\s+/))}d.selectedTextRange={hasSelection:!1}}return d.textChunks=h.chunkText(r,200),d.currentChunk=0,d.textChunks.length>0?d.textChunks[0]:""},chunkText(e,t){if(!e||""===e.trim())return[""];const n=e.trim().split(/\s+/),r=[];for(let e=0;e<n.length;e+=t){const s=n.slice(e,e+t).join(" ");r.push(s)}return r},handleBoundaryEvent(e,t){const n=c();if(n)if(void 0===e.charIndex||void 0===e.charLength||e.charIndex+e.charLength>t.length)console.warn("Invalid boundary event or position out of content bounds");else try{if(d.selectedTextRange?.hasSelection);else{const t=a(),r=(t?.dataset.excludeClass||s).split(/\s+/);0===d.nodePositions.size&&h.buildNodePositionsMap(n,r);const i=e.charIndex;let o=null,c={node:null,distance:Number.MAX_SAFE_INTEGER};const l=Array.from(d.nodePositions.keys()).sort(((e,t)=>e-t));for(let e=0;e<l.length;e++){const t=l[e],n=d.nodePositions.get(t);if(t<=i&&i<t+n.length){o=n.node;break}if("firefox"===d.browserType){const e=Math.abs(t-i);e<c.distance&&(c={node:n.node,distance:e})}}!o&&"firefox"===d.browserType&&c.node&&(o=c.node),o&&o!==d.currentHighlightedNode&&o.textContent.trim().length>0&&(h.clearHighlights(),h.createHighlightWrapper(o),d.currentHighlightedNode=o,o.nodeType!==Node.TEXT_NODE?o.scrollIntoView({behavior:"smooth",block:"center"}):o.parentNode&&o.parentNode.scrollIntoView({behavior:"smooth",block:"center"}))}}catch(e){console.error("Highlighting error:",e)}},handleUtteranceEnd(){h.clearHighlights(),(0,r.getContext)().isPlaying=!1,d.isPlaying=!1,d.currentChunk=0,d.textChunks=[],d.currentHighlightedNode=null,d.selectedTextRange={hasSelection:!1}},buildNodePositionsMap(e,t){d.nodePositions.clear();const n=(e,r=0)=>{if(e.classList)for(const n of t)if(n&&e.classList.contains(n))return r;if(e.nodeType===Node.TEXT_NODE){const t=e.textContent;return t.trim().length>0&&(d.nodePositions.set(r,{node:e,length:t.length}),r+=t.length),r}if(e.childNodes&&e.childNodes.length>0)for(const t of e.childNodes)r=n(t,r);return r};n(e)}},callbacks:{init(){if(!window.speechSynthesis)return void console.warn("Speech synthesis not supported in this browser");window.speechSynthesis.cancel(),d.browserType=l(),console.log(`Browser detected: ${d.browserType}`),g(),h.loadVoices(),void 0!==window.speechSynthesis.onvoiceschanged&&(window.speechSynthesis.onvoiceschanged=h.loadVoices),window.addEventListener("beforeunload",(()=>{window.speechSynthesis.cancel(),"safari"===d.browserType&&(d.utterance&&d.utterance._safariTimerId&&clearInterval(d.utterance._safariTimerId),d.safariKeepAliveTimer&&clearInterval(d.safariKeepAliveTimer))}));const e=c();if(e){const t=a(),n=t?.dataset.excludeClass||s;setTimeout((()=>{h.buildNodePositionsMap(e,n.split(/\s+/))}),500)}},isSelected:()=>(0,r.getContext)().voice.voiceURI===d.currentVoice.voiceURI}}),u={selectCurrentWord:e=>{if(!e||!e.target)return;const t=e.target,n=t.ownerDocument,r=n.defaultView;if(!r)return;let s=null,i="";if(t.nodeType===Node.TEXT_NODE)s=t,i=t.textContent;else{if(!t.firstChild||t.firstChild.nodeType!==Node.TEXT_NODE)return;s=t.firstChild,i=s.textContent}try{const o=r.getSelection();if(!o)return;const a=n.createRange(),c=e.offsetX/t.offsetWidth*i.length;let l=i.lastIndexOf(" ",c);l=-1===l?0:l+1;let d=i.indexOf(" ",c);d=-1===d?i.length:d,a.setStart(s,l),a.setEnd(s,d),o.removeAllRanges(),o.addRange(a)}catch(e){console.warn("Error selecting word:",e)}},getCaretPosition:e=>{if(!e)return 0;try{const t=e.ownerDocument.defaultView.getSelection();if(!t||!t.rangeCount)return 0;const n=t.getRangeAt(0),r=n.cloneRange();return r.selectNodeContents(e),r.setEnd(n.endContainer,n.endOffset),r.toString().length}catch(e){return console.warn("Error getting caret position:",e),0}},calculateNodePositions:()=>{const e=c();if(e)try{const t=document.createTreeWalker(e,NodeFilter.SHOW_TEXT,{acceptNode:e=>e.textContent.trim().length>0?NodeFilter.FILTER_ACCEPT:NodeFilter.FILTER_REJECT});let n,r=0;for(d.nodePositions.clear();n=t.nextNode();)d.nodePositions.set(r,{node:n,length:n.textContent.length}),r+=n.textContent.length}catch(e){console.warn("Error calculating node positions:",e)}}},g=()=>{const e=c(),t=a();if(!e||!t)return;const n=t.dataset.highlightBackground||"#ffeb3b",r=t.dataset.highlightColor||"#000000";e.style.setProperty("--mosne-tts-highlight-bg",n),e.style.setProperty("--mosne-tts-highlight-color",r)};var p,f,w,y=n.K;export{y as textToSpeechHelpers};