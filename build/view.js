import*as e from"@wordpress/interactivity";var t={d:(e,n)=>{for(var o in n)t.o(n,o)&&!t.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:n[o]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const n=(s={getContext:()=>e.getContext,store:()=>e.store},i={},t.d(i,s),i),{state:o,actions:c}=(0,n.store)("mosne-text-to-speech-block",{state:{isPlaying:!1,currentVoice:null,preferredVoice:window.localStorage.getItem("mosne-tts-lang-"+document.documentElement.lang)||null,utterance:null,voices:[],currentSpeed:window.localStorage.getItem("mosne-tts-speed-"+document.documentElement.lang)||1,currentPitch:window.localStorage.getItem("mosne-tts-pitch-"+document.documentElement.lang)||1},actions:{loadVoices(){const e=window.speechSynthesis.getVoices();if(!e||0===e.length)return void setTimeout((()=>c.loadVoices()),100);o.voices=e,o.currentVoice=e[0];const t=document.documentElement.lang,n=e.filter((e=>e.lang.startsWith(t)));if(n.length>0&&(o.voices=n,o.currentVoice=n[0],o.preferredVoice)){const e=n.find((e=>e.voiceURI===o.preferredVoice));e&&(o.currentVoice=e)}setTimeout((()=>{c.createUtterance()}),50)},createUtterance(){const e=c.getContent(),t=new window.SpeechSynthesisUtterance(e);t.lang=document.documentElement.lang,t.rate=o.currentSpeed,t.pitch=o.currentPitch;const n=document.querySelector("main");if(t.onboundary=function(t){if(!n)return;if(n.querySelectorAll(".mosne-tts-highlighted-word").forEach((e=>{e.parentNode.replaceChild(document.createTextNode(e.textContent),e)})),!t.charIndex||!t.charLength||t.charIndex+t.charLength>e.length)return;const o=document.createRange(),c=document.createTreeWalker(n,NodeFilter.SHOW_TEXT,{acceptNode:function(e){let t=e.parentElement;for(;t;){if(t.classList&&t.classList.contains("skip-speech"))return NodeFilter.FILTER_REJECT;t=t.parentElement}return NodeFilter.FILTER_ACCEPT}},!1);let s,i=0,r=null,a=0,l=null,d=0;for(;s=c.nextNode();){const e=s.length;if(!r&&i+e>t.charIndex&&(r=s,a=t.charIndex-i),r&&i+e>t.charIndex+t.charLength){l=s,d=Math.min(t.charIndex+t.charLength-i,s.length);break}i+=e}if(r&&l&&a<=r.length&&d<=l.length)try{o.setStart(r,a),o.setEnd(l,d);const e=document.createElement("span");e.className="mosne-tts-highlighted-word",o.surroundContents(e)}catch(e){}},o.currentVoice){const e=o.voices.find((e=>e.voiceURI===o.currentVoice.voiceURI));t.voice=e}o.utterance=t},updateUtterance(){if(o.utterance){window.speechSynthesis.cancel();const e=document.querySelector("main");e&&e.querySelectorAll(".mosne-tts-highlighted-word").forEach((e=>{e.parentNode.replaceChild(document.createTextNode(e.textContent),e)})),o.isPlaying=!1,new Promise((e=>{const t=()=>{window.speechSynthesis.speaking||window.speechSynthesis.pending?setTimeout(t,100):e()};t()})).then((()=>{c.createUtterance()}))}},Play(){if((0,n.getContext)().isPlaying=!0,!window.speechSynthesis.paused)return window.speechSynthesis.speaking?(window.speechSynthesis.cancel(),void setTimeout((()=>{o.utterance&&window.speechSynthesis.speak(o.utterance)}),50)):void(o.utterance&&window.speechSynthesis.speak(o.utterance));window.speechSynthesis.resume()},Pause(){(0,n.getContext)().isPlaying=!1,window.speechSynthesis.speaking&&!window.speechSynthesis.paused&&window.speechSynthesis.pause()},Restart(){(0,n.getContext)().isPlaying=!1,window.speechSynthesis.cancel(),document.querySelector("main").querySelectorAll(".mosne-tts-highlighted-word").forEach((e=>{e.parentNode.replaceChild(document.createTextNode(e.textContent),e)}))},changeVoice(e){(0,n.getContext)().isPlaying=!1,window.speechSynthesis.cancel();const t=o.voices.find((t=>t.voiceURI===e.target.value));t&&(o.currentVoice=t,window.localStorage.setItem("mosne-tts-lang-"+document.documentElement.lang,t.voiceURI),setTimeout((()=>{c.updateUtterance()}),50))},changeSpeed(e){o.currentSpeed=e.target.value,window.localStorage.setItem("mosne-tts-speed-"+document.documentElement.lang,e.target.value),c.updateUtterance()},changePitch(e){o.currentPitch=e.target.value,window.localStorage.setItem("mosne-tts-pitch-"+document.documentElement.lang,e.target.value),c.updateUtterance()},toggleSettings(){const e=(0,n.getContext)();e.showSettings=!e.showSettings},getContent(){let e="",t=document.querySelector("main").cloneNode(!0);return t&&(t.querySelectorAll(".skip-speech").forEach((e=>{e.remove()})),e=t.textContent,t=null),e}},callbacks:{init(){window.speechSynthesis&&(window.speechSynthesis.cancel(),c.loadVoices(),void 0!==window.speechSynthesis.onvoiceschanged&&(window.speechSynthesis.onvoiceschanged=c.loadVoices))},isSelected:()=>(0,n.getContext)().voice.voiceURI===o.currentVoice.voiceURI}});var s,i;const r=document.createElement("style");r.textContent="\n\t.mosne-tts-highlighted-word {\n\t\toutline: 2px solid currentColor;\n\t\toutline-offset: 3px;\n\t}\n",document.head.appendChild(r);