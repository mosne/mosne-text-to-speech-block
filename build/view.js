import*as e from"@wordpress/interactivity";var t={d:(e,r)=>{for(var n in r)t.o(r,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const r=(H={getContext:()=>e.getContext,store:()=>e.store},K={},t.d(K,H),K),n="skip-speech",o={MAX_INPUT_LENGTH:1e3,MAX_SPEED:10,MIN_SPEED:.1,MAX_PITCH:2,MIN_PITCH:.1,ALLOWED_CSS_PROPERTIES:["--mosne-tts-highlight-bg","--mosne-tts-highlight-color"],SAFE_COLOR_PATTERN:/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$|^rgb\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$|^rgba\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*[\d.]+\s*\)$/,SAFE_KEY_PATTERN:/^[a-zA-Z0-9-_]+$/,SAFE_VOICE_URI_PATTERN:/^[a-zA-Z0-9._-]+$/},s=(e,t=o.MAX_INPUT_LENGTH)=>"string"!=typeof e||e.length>t?null:e.replace(/[<>'"&]/g,"").trim(),i=(e,t,r)=>{const n=parseFloat(e);return isNaN(n)||n<t||n>r?null:n},c=e=>e&&"object"==typeof e&&e.target&&"object"==typeof e.target?e:null,a=e=>"string"!=typeof e?"":e.replace(/[<>'"&]/g,"").replace(/\s+/g," ").trim(),l=e=>"string"!=typeof e?"#ffeb3b":o.SAFE_COLOR_PATTERN.test(e)?e:"#ffeb3b",u=(e,t)=>{try{if(!o.SAFE_KEY_PATTERN.test(e))return console.warn("Invalid storage key format:",e),!1;const r=s(t);return r?(window.localStorage.setItem(e,r),!0):(console.warn("Invalid storage value:",t),!1)}catch(e){return console.warn("Storage operation failed:",e.message),!1}},h=(e,t,r)=>{if(!e||!t||!r)return!1;if(!o.ALLOWED_CSS_PROPERTIES.includes(t))return console.warn("Unsafe CSS property:",t),!1;const n=l(r);return e.style.setProperty(t,n),!0},g=(e,t=document)=>{if(!e||"string"!=typeof e)return null;if(!/^[a-zA-Z0-9\s._\-\[\]#:(),>+~*="']+$/.test(e))return console.warn("Potentially unsafe selector:",e),null;try{return t.querySelector(e)}catch(e){return console.warn("Query selector failed:",e.message),null}},d={logError:(e,t,r={})=>{const n={context:e,message:t.message||"Unknown error",timestamp:(new Date).toISOString(),...r};console.error(`[TTS Error] ${e}:`,n)},handleSpeechError:(e,t)=>{const r={errorType:e.error||"unknown",isPlaying:t.isPlaying,currentChunk:t.currentChunk};d.logError("Speech Synthesis",e,r),t&&(t.isPlaying=!1,t.currentChunk=0)}},p=e=>i(e,o.MIN_SPEED,o.MAX_SPEED),f=e=>i(e,o.MIN_PITCH,o.MAX_PITCH),y=(e,t=[])=>{const r=(e=>e&&"string"==typeof e&&o.SAFE_VOICE_URI_PATTERN.test(e)?e:null)(e);return r&&t.find((e=>e.voiceURI===r))||null},w=(e,t)=>((e,t=null)=>{try{if(!o.SAFE_KEY_PATTERN.test(e))return t;const r=window.localStorage.getItem(e);return r&&s(r)||t}catch(e){return console.warn("Storage retrieval failed:",e.message),t}})(e,t),E=()=>{try{const e=document.documentElement.lang;return a(e)||"en"}catch(e){return d.logError("Get Current Locale",e),"en"}},S=()=>g('[data-wp-interactive="mosne-text-to-speech-block"]'),v=()=>g("main"),C={isPlaying:!1,currentVoice:null,preferredVoice:w(`mosne-tts-lang-${E()}`,null),utterance:null,voices:[],currentSpeed:w((O=E(),`mosne-tts-speed-${O}`),1),currentPitch:w((e=>`mosne-tts-pitch-${e}`)(E()),1),selectedTextRange:{hasSelection:!1},currentChunk:0,textChunks:[],isProcessingChunks:!1,currentHighlightedNode:null,nodePositions:new Map,currentSelection:null,pausedAt:null,browserType:(()=>{try{const e=window.navigator.userAgent;if(!e||"string"!=typeof e)return"other";const t=a(e);return-1!==t.indexOf("Firefox")?"firefox":-1!==t.indexOf("Edge")||-1!==t.indexOf("Edg")?"edge":-1!==t.indexOf("Safari")&&-1===t.indexOf("Chrome")?"safari":-1!==t.indexOf("Chrome")?"chrome":"other"}catch(e){return d.logError("Get Browser",e),"other"}})(),safariKeepAliveTimer:null},I=()=>new Promise((e=>{const t=()=>{window.speechSynthesis.speaking||window.speechSynthesis.pending?setTimeout(t,100):e()};t()})),T=e=>{"safari"===e.browserType&&(e.safariKeepAliveTimer&&clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=setInterval((()=>{e.isPlaying&&window.speechSynthesis.speaking?(window.speechSynthesis.pause(),window.speechSynthesis.resume()):(clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=null)}),1e4))},m=e=>{if(e.currentSelection){try{e.currentSelection.removeAllRanges()}catch(e){console.warn("Error clearing highlights:",e)}e.currentSelection=null}e.currentHighlightedNode=null},x=(e,t)=>{if("safari"!==e.browserType)return null;const r=15*e.currentSpeed;let n=0;const o=setInterval((()=>{e.isPlaying?(P(e,{charIndex:n,charLength:1},t),n+=Math.ceil(250*r/1e3)):clearInterval(o)}),250);return o},P=(e,t)=>{const r=v();if(r)try{let o=t.charIndex;if(e.currentChunk>0)for(let t=0;t<e.currentChunk;t++)o+=e.textChunks[t].length+1;if(e.selectedTextRange?.hasSelection);else{const t=S(),s=(t?.dataset.excludeClass||n).split(/\s+/);0===e.nodePositions.size&&k(e,r,s);let i=null,c={node:null,distance:Number.MAX_SAFE_INTEGER};const a=Array.from(e.nodePositions.keys()).sort(((e,t)=>e-t));for(let t=0;t<a.length;t++){const r=a[t],n=e.nodePositions.get(r);if(r<=o&&o<r+n.length){i=n.node;break}if("firefox"===e.browserType){const e=Math.abs(r-o);e<c.distance&&(c={node:n.node,distance:e})}}!i&&"firefox"===e.browserType&&c.node&&(i=c.node),i&&i!==e.currentHighlightedNode&&i.textContent.trim().length>0&&(m(e),((e,t)=>{if(!t)return null;const r=t.ownerDocument,n=r.defaultView;if(!n)return null;m(e);try{const o=r.createRange();t.nodeType===Node.TEXT_NODE?(o.setStart(t,0),o.setEnd(t,t.length)):o.selectNodeContents(t);const s=n.getSelection();s&&(s.removeAllRanges(),s.addRange(o),e.currentSelection=s,s.rangeCount>0&&(s.getRangeAt(0),s.getRangeAt(0)))}catch(e){console.warn("Error creating highlight:",e)}})(e,i),e.currentHighlightedNode=i,i.nodeType!==Node.TEXT_NODE?i.scrollIntoView({behavior:"smooth",block:"center"}):i.parentNode&&i.parentNode.scrollIntoView({behavior:"smooth",block:"center"}))}}catch(e){console.error("Highlighting error:",e)}},k=(e,t,r)=>{e.nodePositions.clear();const n=(t,o=0)=>{if(t.classList)for(const e of r)if(e&&t.classList.contains(e))return o;if(t.nodeType===Node.TEXT_NODE){const r=t.textContent;return r.trim().length>0&&(e.nodePositions.set(o,{node:t,length:r.length}),o+=r.length),o}if(t.childNodes&&t.childNodes.length>0)for(const e of t.childNodes)o=n(e,o);return o};n(t)},A=(e,t)=>{const r=e.textChunks[e.currentChunk],n=new window.SpeechSynthesisUtterance(r);if(n.lang=E(),n.rate=e.currentSpeed,n.pitch=e.currentPitch,e.currentVoice){const t=e.voices.find((t=>t.voiceURI===e.currentVoice.voiceURI));n.voice=t}_(e,n,r,t),e.utterance=n},_=(e,t,r,n)=>{"safari"===e.browserType?(t.onboundary=n=>{t._lastCharIndex=n.charIndex||0,P(e,n,r)},t._safariTimerId=x(e,r)):t.onboundary=n=>{t._lastCharIndex=n.charIndex||0;const o=void 0!==t._contentOffset?{...n,charIndex:(n.charIndex||0)+t._contentOffset}:n;P(e,o,r)},t.onend=()=>{t._safariTimerId&&clearInterval(t._safariTimerId),e.currentChunk<e.textChunks.length-1?(e.currentChunk++,A(e,n),setTimeout((()=>{e.isPlaying&&e.utterance&&window.speechSynthesis.speak(e.utterance)}),50)):(n&&(n.isPlaying=!1),e.isPlaying=!1,m(e))},t.onerror=t=>{console.error("Speech synthesis error:",t),"interrupted"===t.error&&(speechSynthesis.cancel(),b(e))}},b=e=>{m(e),e.isPlaying=!1,e.currentChunk=0,e.textChunks=[],e.currentHighlightedNode=null,e.selectedTextRange={hasSelection:!1}},R=async e=>{try{"safari"===e.browserType&&(window.speechSynthesis.speak(new SpeechSynthesisUtterance("")),window.speechSynthesis.cancel());const t=window.speechSynthesis.getVoices();if(!t?.length)return void setTimeout((()=>R(e)),100);const r=E(),n=t.filter((e=>e&&"string"==typeof e.lang&&"string"==typeof e.voiceURI&&e.lang.length>0&&e.voiceURI.length>0));if(0===n.length)return void d.logError("Load Voices",new Error("No valid voices found"));const o=n.filter((e=>e.lang.startsWith(r)));if(e.voices=o.length>0?o:n,e.currentVoice=e.voices[0],e.preferredVoice){const t=y(e.preferredVoice,e.voices);t&&(e.currentVoice=t)}return setTimeout((()=>A(e)),50),!0}catch(e){return d.logError("Load Voices",e),!1}},N=e=>{try{const t=v();if(!t)return d.logError("Get Content",new Error("Main element not found")),"";const r=t.ownerDocument.defaultView,o=r?r.getSelection():null;let s="";if(o&&o.toString().trim().length>0){const t=o.toString();s=a(t),e.selectedTextRange={text:s,hasSelection:!0}}else{const r=S(),o=(r?.dataset.excludeClass||n).split(/\s+/).filter((e=>e.trim()));let i=t.cloneNode(!0);if(i){const e=/^[A-Za-z0-9_-]+$/;o.forEach((t=>{if(t&&e.test(t)){const e="undefined"!=typeof CSS&&CSS.escape?CSS.escape(t):t;i.querySelectorAll(`.${e}`).forEach((e=>{e.remove()}))}})),s=(e=>{if(!e)return"";const t=e.textContent||"";return a(t)})(i),i=null}t&&k(e,t,o),e.selectedTextRange={hasSelection:!1}}return s.length>5e4&&(d.logError("Get Content",new Error("Content too long for processing")),s=s.substring(0,5e4)),e.textChunks=V(s,200),e.currentChunk=0,e.textChunks.length>0?e.textChunks[0]:""}catch(e){return d.logError("Get Content",e),""}},V=(e,t)=>{try{if(!e||"string"!=typeof e||""===e.trim())return[""];(!t||t<1||t>1e3)&&(t=200);const r=a(e).trim().split(/\s+/).filter((e=>e.length>0)),n=[];for(let e=0;e<r.length;e+=t){const o=r.slice(e,e+t).join(" ");o.trim().length>0&&n.push(o)}return n.length>0?n:[""]}catch(e){return d.logError("Chunk Text",e),[""]}},{state:U}=(0,r.store)("mosne-text-to-speech-block",{state:C,actions:{checkSynthesisReady:()=>{try{return I()}catch(e){return d.logError("Synthesis Ready Check",e),!1}},setupSafariKeepAlive:()=>{try{return T(U)}catch(e){return d.logError("Safari Keep Alive",e),!1}},buildNodePositionsMap:()=>{try{return k(U)}catch(e){return d.logError("Node Positions Map",e),!1}},handleBoundaryEvent:()=>{try{return P(U)}catch(e){return d.logError("Boundary Event",e),!1}},setupSafariHighlighting:()=>{try{return x(U)}catch(e){return d.logError("Safari Highlighting",e),!1}},clearHighlights:()=>{try{return m(U)}catch(e){return d.logError("Clear Highlights",e),!1}},loadVoices:()=>{try{return R(U)}catch(e){return d.logError("Load Voices",e),!1}},changeVoice:e=>{try{const t=c(e);if(!t)return console.warn("Invalid voice change event"),!1;const n=s(t.target.value);return n?((e,t)=>{try{const n=c(t);if(!n)return d.logError("Change Voice",new Error("Invalid event object")),!1;const o=s(n.target.value);if(!o)return d.logError("Change Voice",new Error("Invalid voice URI")),!1;window.speechSynthesis.cancel();const i=(0,r.getContext)();i&&(i.isPlaying=!1);const a=y(o,e.voices);if(!a)return d.logError("Change Voice",new Error("Voice not found in available voices")),!1;e.currentVoice=a;const l=`mosne-tts-lang-${E()}`;return u(l,a.voiceURI)||d.logError("Change Voice",new Error("Failed to save voice to localStorage")),!0}catch(e){return d.logError("Change Voice",e),!1}})(U,{target:{value:n}}):(console.warn("Invalid voice URI"),!1)}catch(e){return d.logError("Change Voice",e),!1}},createUtterance:()=>{try{return A(U)}catch(e){return d.logError("Create Utterance",e),!1}},setupUtteranceEvents:()=>{try{return _(U)}catch(e){return d.logError("Setup Utterance Events",e),!1}},handleUtteranceEnd:()=>{try{return b(U)}catch(e){return d.logError("Handle Utterance End",e),!1}},Play:()=>{try{return(async e=>{const t=(0,r.getContext)();if(t&&(t.isPlaying=!0),e.isPlaying=!0,"firefox"===e.browserType&&e.pausedAt){const t=e.pausedAt.text.substring(e.pausedAt.charIndex);e.currentChunk=e.pausedAt.chunk;const r=new window.SpeechSynthesisUtterance(t);if(r.lang=E(),r.rate=e.currentSpeed,r.pitch=e.currentPitch,r._lastCharIndex=0,r._contentOffset=e.pausedAt.contentPosition,e.currentVoice){const t=e.voices.find((t=>t.voiceURI===e.currentVoice.voiceURI));r.voice=t}return r.onboundary=t=>{r._lastCharIndex=t.charIndex||0;const o=(t.charIndex||0)+e.pausedAt.contentPosition,s={...t,charIndex:o,charLength:t.charLength||1},i=v();if(i){const t=S(),r=t?.dataset.excludeClass||n;0===e.nodePositions.size&&k(e,i,r.split(/\s+/)),P(e,s,e.pausedAt.fullText||e.pausedAt.text)}},r.onend=()=>b(e),e.utterance=r,window.speechSynthesis.speak(e.utterance),"safari"===e.browserType&&T(e),void(e.pausedAt=null)}0!==e.textChunks.length&&0!==e.currentChunk||(N(e),A(e,t));try{if(window.speechSynthesis.paused)return void window.speechSynthesis.resume()}catch(r){console.warn("Resume failed, recreating speech:",r),A(e,t)}if(("chrome"===e.browserType||"edge"===e.browserType)&&window.speechSynthesis.speaking)return window.speechSynthesis.cancel(),void setTimeout((()=>{e.utterance&&window.speechSynthesis.speak(e.utterance)}),50);e.utterance&&(window.speechSynthesis.speak(e.utterance),"safari"===e.browserType&&T(e))})(U)}catch(e){return d.logError("Play Action",e),!1}},Pause:()=>{try{return(async e=>{const t=(0,r.getContext)();if(t&&(t.isPlaying=!1),e.isPlaying=!1,m(e),"firefox"===e.browserType){if(window.speechSynthesis.speaking){const t=e.textChunks.join(" ");e.pausedAt={text:e.utterance.text,charIndex:e.utterance._lastCharIndex||0,chunk:e.currentChunk,contentPosition:e.utterance._lastCharIndex+(e.currentChunk>0?e.textChunks.slice(0,e.currentChunk).reduce(((e,t)=>e+t.length),0):0),fullText:t},window.speechSynthesis.cancel()}}else if("safari"===e.browserType){if(window.speechSynthesis.speaking){const t=e.textChunks.join(" ");e.pausedAt={text:e.utterance.text,charIndex:e.utterance._lastCharIndex||0,chunk:e.currentChunk,contentPosition:e.utterance._lastCharIndex+(e.currentChunk>0?e.textChunks.slice(0,e.currentChunk).reduce(((e,t)=>e+t.length),0):0),fullText:t},e.utterance._safariTimerId&&clearInterval(e.utterance._safariTimerId),e.safariKeepAliveTimer&&(clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=null),window.speechSynthesis.cancel()}}else window.speechSynthesis.speaking&&!window.speechSynthesis.paused&&window.speechSynthesis.pause()})(U)}catch(e){return d.logError("Pause Action",e),!1}},Restart:()=>{try{return(e=>{const t=(0,r.getContext)();t&&(t.isPlaying=!1),e.isPlaying=!1,"safari"===e.browserType&&(e.utterance&&e.utterance._safariTimerId&&clearInterval(e.utterance._safariTimerId),e.safariKeepAliveTimer&&(clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=null)),window.speechSynthesis.cancel(),e.currentChunk=0,e.textChunks=[],m(e)})(U)}catch(e){return d.logError("Restart Action",e),!1}},changeSpeed:e=>{try{const t=c(e);if(!t)return console.warn("Invalid speed change event"),!1;const n=p(t.target.value);if(null===n)return console.warn("Invalid speed value:",t.target.value),!1;const o={target:{value:n.toString()}};return(async(e,t)=>{try{const n=c(t);if(!n)return d.logError("Change Speed",new Error("Invalid event object")),!1;const o=p(n.target.value);if(null===o)return d.logError("Change Speed",new Error("Invalid speed value")),!1;window.speechSynthesis.cancel();const s=(0,r.getContext)();s&&(s.isPlaying=!1),e.currentSpeed=o;const i=`mosne-tts-speed-${E()}`;return u(i,o.toString())||d.logError("Change Speed",new Error("Failed to save speed to localStorage")),await I(),A(e,s),s&&!s.isPlaying&&setTimeout((()=>{s.isPlaying=!0,window.speechSynthesis.speak(e.utterance)}),50),!0}catch(e){return d.logError("Change Speed",e),!1}})(U,o)}catch(e){return d.logError("Change Speed",e),!1}},changePitch:e=>{try{const t=c(e);if(!t)return console.warn("Invalid pitch change event"),!1;const n=f(t.target.value);if(null===n)return console.warn("Invalid pitch value:",t.target.value),!1;const o={target:{value:n.toString()}};return(async(e,t)=>{try{const n=c(t);if(!n)return d.logError("Change Pitch",new Error("Invalid event object")),!1;const o=f(n.target.value);if(null===o)return d.logError("Change Pitch",new Error("Invalid pitch value")),!1;window.speechSynthesis.cancel();const s=(0,r.getContext)();s&&(s.isPlaying=!1),e.currentPitch=o;const i=`mosne-tts-pitch-${E()}`;return u(i,o.toString())||d.logError("Change Pitch",new Error("Failed to save pitch to localStorage")),await I(),A(e,s),s&&!s.isPlaying&&setTimeout((()=>{s.isPlaying=!0,window.speechSynthesis.speak(e.utterance)}),50),!0}catch(e){return d.logError("Change Pitch",e),!1}})(U,o)}catch(e){return d.logError("Change Pitch",e),!1}},toggleSettings:()=>{try{return(()=>{try{const e=(0,r.getContext)();return e&&(e.showSettings=!e.showSettings),!0}catch(e){return d.logError("Toggle Settings",e),!1}})()}catch(e){return d.logError("Toggle Settings",e),!1}},getContent:()=>{try{return N(U)}catch(e){return d.logError("Get Content",e),!1}}},callbacks:{init:()=>{try{return(e=>{try{if(!window.speechSynthesis)return d.logError("Init Callback",new Error("Speech synthesis not supported in this browser")),!1;window.speechSynthesis.cancel();const t=(()=>{try{const e=v(),t=S();if(!e||!t)return d.logError("Init Highlight Colors",new Error("Required elements not found")),!1;const r=t.dataset.highlightBackground||"#ffeb3b",n=t.dataset.highlightColor||"#000000",o=l(r),s=l(n),i=h(e,"--mosne-tts-highlight-bg",o),c=h(e,"--mosne-tts-highlight-color",s);return i&&c}catch(e){return d.logError("Init Highlight Colors",e),!1}})();t||d.logError("Init Callback",new Error("Failed to initialize highlight colors")),R(e)||d.logError("Init Callback",new Error("Failed to load voices")),void 0!==window.speechSynthesis.onvoiceschanged&&(window.speechSynthesis.onvoiceschanged=()=>{try{R(e)}catch(e){d.logError("Voices Changed Event",e)}}),window.addEventListener("beforeunload",(()=>{try{window.speechSynthesis.cancel(),"safari"===e.browserType&&(e.utterance&&e.utterance._safariTimerId&&clearInterval(e.utterance._safariTimerId),e.safariKeepAliveTimer&&clearInterval(e.safariKeepAliveTimer))}catch(e){d.logError("Before Unload Event",e)}}));const r=v();if(r){const t=S(),o=(t?.dataset.excludeClass||n).split(/\s+/).filter((e=>e.trim()));setTimeout((()=>{try{k(e,r,o)}catch(e){d.logError("Build Node Positions Map",e)}}),500)}return!0}catch(e){return d.logError("Init Callback",e),!1}})(U)}catch(e){return d.logError("Init Callback",e),!1}},isSelected:()=>{try{return(e=>{try{const t=(0,r.getContext)();return!(!t||!e)&&t.voice?.voiceURI===e.currentVoice?.voiceURI}catch(e){return d.logError("Is Selected Callback",e),!1}})(U)}catch(e){return d.logError("Is Selected Callback",e),!1}}}});var O,H,K;