import{getContext as e,store as t}from"@wordpress/interactivity";const r="skip-speech",n={MAX_INPUT_LENGTH:1e3,MAX_SPEED:10,MIN_SPEED:.1,MAX_PITCH:2,MIN_PITCH:.1,ALLOWED_CSS_PROPERTIES:["--mosne-tts-highlight-bg","--mosne-tts-highlight-color"],SAFE_COLOR_PATTERN:/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$|^rgb\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*\)$|^rgba\(\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*\d{1,3}\s*,\s*[\d.]+\s*\)$/,SAFE_KEY_PATTERN:/^[a-zA-Z0-9-_]+$/,SAFE_VOICE_URI_PATTERN:/^[a-zA-Z0-9._-]+$/},o=(e,t=n.MAX_INPUT_LENGTH)=>"string"!=typeof e||e.length>t?null:e.replace(/[<>'"&]/g,"").trim(),s=(e,t,r)=>{const n=parseFloat(e);return isNaN(n)||n<t||n>r?null:n},i=e=>e&&"object"==typeof e&&e.target&&"object"==typeof e.target?e:null,c=e=>"string"!=typeof e?"":e.replace(/[<>'"&]/g,"").replace(/\s+/g," ").trim(),a=e=>"string"!=typeof e?"#ffeb3b":n.SAFE_COLOR_PATTERN.test(e)?e:"#ffeb3b",l=(e,t)=>{try{if(!n.SAFE_KEY_PATTERN.test(e))return console.warn("Invalid storage key format:",e),!1;const r=o(t);return r?(window.localStorage.setItem(e,r),!0):(console.warn("Invalid storage value:",t),!1)}catch(e){return console.warn("Storage operation failed:",e.message),!1}},u=(e,t,r)=>{if(!e||!t||!r)return!1;if(!n.ALLOWED_CSS_PROPERTIES.includes(t))return console.warn("Unsafe CSS property:",t),!1;const o=a(r);return e.style.setProperty(t,o),!0},h=(e,t=document)=>{if(!e||"string"!=typeof e)return null;if(!/^[a-zA-Z0-9\s._\-\[\]#:(),>+~*="']+$/.test(e))return console.warn("Potentially unsafe selector:",e),null;try{return t.querySelector(e)}catch(e){return console.warn("Query selector failed:",e.message),null}},g={logError:(e,t,r={})=>{const n={context:e,message:t.message||"Unknown error",timestamp:(new Date).toISOString(),...r};console.error(`[TTS Error] ${e}:`,n)},handleSpeechError:(e,t)=>{const r={errorType:e.error||"unknown",isPlaying:t.isPlaying,currentChunk:t.currentChunk};g.logError("Speech Synthesis",e,r),t&&(t.isPlaying=!1,t.currentChunk=0)}},d=e=>s(e,n.MIN_SPEED,n.MAX_SPEED),p=e=>s(e,n.MIN_PITCH,n.MAX_PITCH),f=(e,t=[])=>{const r=(e=>e&&"string"==typeof e&&n.SAFE_VOICE_URI_PATTERN.test(e)?e:null)(e);return r&&t.find(e=>e.voiceURI===r)||null},y=(e,t)=>((e,t=null)=>{try{if(!n.SAFE_KEY_PATTERN.test(e))return t;const r=window.localStorage.getItem(e);return r&&o(r)||t}catch(e){return console.warn("Storage retrieval failed:",e.message),t}})(e,t),w=()=>{try{const e=document.documentElement.lang;return c(e)||"en"}catch(e){return g.logError("Get Current Locale",e),"en"}},E=()=>h('[data-wp-interactive="mosne-text-to-speech-block"]'),S=()=>h("main"),v={isPlaying:!1,currentVoice:null,preferredVoice:y(`mosne-tts-lang-${w()}`,null),utterance:null,voices:[],currentSpeed:y((U=w(),`mosne-tts-speed-${U}`),1),currentPitch:y((e=>`mosne-tts-pitch-${e}`)(w()),1),selectedTextRange:{hasSelection:!1},currentChunk:0,textChunks:[],isProcessingChunks:!1,currentHighlightedNode:null,nodePositions:new Map,currentSelection:null,pausedAt:null,browserType:(()=>{try{const e=window.navigator.userAgent;if(!e||"string"!=typeof e)return"other";const t=c(e);return-1!==t.indexOf("Firefox")?"firefox":-1!==t.indexOf("Edge")||-1!==t.indexOf("Edg")?"edge":-1!==t.indexOf("Safari")&&-1===t.indexOf("Chrome")?"safari":-1!==t.indexOf("Chrome")?"chrome":"other"}catch(e){return g.logError("Get Browser",e),"other"}})(),safariKeepAliveTimer:null},C=()=>new Promise(e=>{const t=()=>{window.speechSynthesis.speaking||window.speechSynthesis.pending?setTimeout(t,100):e()};t()}),I=e=>{"safari"===e.browserType&&(e.safariKeepAliveTimer&&clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=setInterval(()=>{e.isPlaying&&window.speechSynthesis.speaking?(window.speechSynthesis.pause(),window.speechSynthesis.resume()):(clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=null)},1e4))},T=e=>{if(e.currentSelection){try{e.currentSelection.removeAllRanges()}catch(e){console.warn("Error clearing highlights:",e)}e.currentSelection=null}e.currentHighlightedNode=null},m=(e,t)=>{if("safari"!==e.browserType)return null;const r=15*e.currentSpeed;let n=0;const o=setInterval(()=>{e.isPlaying?(P(e,{charIndex:n,charLength:1},t),n+=Math.ceil(250*r/1e3)):clearInterval(o)},250);return o},P=(e,t)=>{const n=S();if(n)try{let o=t.charIndex;if(e.currentChunk>0)for(let t=0;t<e.currentChunk;t++)o+=e.textChunks[t].length+1;if(e.selectedTextRange?.hasSelection);else{const t=E(),s=(t?.dataset.excludeClass||r).split(/\s+/);0===e.nodePositions.size&&k(e,n,s);let i=null,c={node:null,distance:Number.MAX_SAFE_INTEGER};const a=Array.from(e.nodePositions.keys()).sort((e,t)=>e-t);for(let t=0;t<a.length;t++){const r=a[t],n=e.nodePositions.get(r);if(r<=o&&o<r+n.length){i=n.node;break}if("firefox"===e.browserType){const e=Math.abs(r-o);e<c.distance&&(c={node:n.node,distance:e})}}!i&&"firefox"===e.browserType&&c.node&&(i=c.node),i&&i!==e.currentHighlightedNode&&i.textContent.trim().length>0&&(T(e),((e,t)=>{if(!t)return null;const r=t.ownerDocument,n=r.defaultView;if(!n)return null;T(e);try{const o=r.createRange();t.nodeType===Node.TEXT_NODE?(o.setStart(t,0),o.setEnd(t,t.length)):o.selectNodeContents(t);const s=n.getSelection();s&&(s.removeAllRanges(),s.addRange(o),e.currentSelection=s,s.rangeCount>0&&(s.getRangeAt(0),s.getRangeAt(0)))}catch(e){console.warn("Error creating highlight:",e)}})(e,i),e.currentHighlightedNode=i,i.nodeType!==Node.TEXT_NODE?i.scrollIntoView({behavior:"smooth",block:"center"}):i.parentNode&&i.parentNode.scrollIntoView({behavior:"smooth",block:"center"}))}}catch(e){console.error("Highlighting error:",e)}},k=(e,t,r)=>{e.nodePositions.clear();const n=(t,o=0)=>{if(t.classList)for(const e of r)if(e&&t.classList.contains(e))return o;if(t.nodeType===Node.TEXT_NODE){const r=t.textContent;return r.trim().length>0&&(e.nodePositions.set(o,{node:t,length:r.length}),o+=r.length),o}if(t.childNodes&&t.childNodes.length>0)for(const e of t.childNodes)o=n(e,o);return o};n(t)},x=(e,t)=>{const r=e.textChunks[e.currentChunk],n=new window.SpeechSynthesisUtterance(r);if(n.lang=w(),n.rate=e.currentSpeed,n.pitch=e.currentPitch,e.currentVoice){const t=e.voices.find(t=>t.voiceURI===e.currentVoice.voiceURI);n.voice=t}A(e,n,r,t),e.utterance=n},A=(e,t,r,n)=>{"safari"===e.browserType?(t.onboundary=n=>{t._lastCharIndex=n.charIndex||0,P(e,n,r)},t._safariTimerId=m(e,r)):t.onboundary=n=>{t._lastCharIndex=n.charIndex||0;const o=void 0!==t._contentOffset?{...n,charIndex:(n.charIndex||0)+t._contentOffset}:n;P(e,o,r)},t.onend=()=>{t._safariTimerId&&clearInterval(t._safariTimerId),e.currentChunk<e.textChunks.length-1?(e.currentChunk++,x(e,n),setTimeout(()=>{e.isPlaying&&e.utterance&&window.speechSynthesis.speak(e.utterance)},50)):(n&&(n.isPlaying=!1),e.isPlaying=!1,T(e))},t.onerror=t=>{console.error("Speech synthesis error:",t),"interrupted"===t.error&&(speechSynthesis.cancel(),_(e))}},_=e=>{T(e),e.isPlaying=!1,e.currentChunk=0,e.textChunks=[],e.currentHighlightedNode=null,e.selectedTextRange={hasSelection:!1}},b=async e=>{try{"safari"===e.browserType&&(window.speechSynthesis.speak(new SpeechSynthesisUtterance("")),window.speechSynthesis.cancel());const t=window.speechSynthesis.getVoices();if(!t?.length)return void setTimeout(()=>b(e),100);const r=w(),n=t.filter(e=>e&&"string"==typeof e.lang&&"string"==typeof e.voiceURI&&e.lang.length>0&&e.voiceURI.length>0);if(0===n.length)return void g.logError("Load Voices",new Error("No valid voices found"));const o=n.filter(e=>e.lang.startsWith(r));if(e.voices=o.length>0?o:n,e.currentVoice=e.voices[0],e.preferredVoice){const t=f(e.preferredVoice,e.voices);t&&(e.currentVoice=t)}return setTimeout(()=>x(e),50),!0}catch(e){return g.logError("Load Voices",e),!1}},R=e=>{try{const t=S();if(!t)return g.logError("Get Content",new Error("Main element not found")),"";const n=t.ownerDocument.defaultView,o=n?n.getSelection():null;let s="";if(o&&o.toString().trim().length>0){const t=o.toString();s=c(t),e.selectedTextRange={text:s,hasSelection:!0}}else{const n=E(),o=(n?.dataset.excludeClass||r).split(/\s+/).filter(e=>e.trim());let i=t.cloneNode(!0);if(i){const e=/^[A-Za-z0-9_-]+$/;o.forEach(t=>{if(t&&e.test(t)){const e="undefined"!=typeof CSS&&CSS.escape?CSS.escape(t):t;i.querySelectorAll(`.${e}`).forEach(e=>{e.remove()})}}),s=(e=>{if(!e)return"";const t=e.textContent||"";return c(t)})(i),i=null}t&&k(e,t,o),e.selectedTextRange={hasSelection:!1}}return s.length>5e4&&(g.logError("Get Content",new Error("Content too long for processing")),s=s.substring(0,5e4)),e.textChunks=N(s,200),e.currentChunk=0,e.textChunks.length>0?e.textChunks[0]:""}catch(e){return g.logError("Get Content",e),""}},N=(e,t)=>{try{if(!e||"string"!=typeof e||""===e.trim())return[""];(!t||t<1||t>1e3)&&(t=200);const r=c(e).trim().split(/\s+/).filter(e=>e.length>0),n=[];for(let e=0;e<r.length;e+=t){const o=r.slice(e,e+t).join(" ");o.trim().length>0&&n.push(o)}return n.length>0?n:[""]}catch(e){return g.logError("Chunk Text",e),[""]}},{state:V}=t("mosne-text-to-speech-block",{state:v,actions:{checkSynthesisReady:()=>{try{return C()}catch(e){return g.logError("Synthesis Ready Check",e),!1}},setupSafariKeepAlive:()=>{try{return I(V)}catch(e){return g.logError("Safari Keep Alive",e),!1}},buildNodePositionsMap:()=>{try{return k(V)}catch(e){return g.logError("Node Positions Map",e),!1}},handleBoundaryEvent:()=>{try{return P(V)}catch(e){return g.logError("Boundary Event",e),!1}},setupSafariHighlighting:()=>{try{return m(V)}catch(e){return g.logError("Safari Highlighting",e),!1}},clearHighlights:()=>{try{return T(V)}catch(e){return g.logError("Clear Highlights",e),!1}},loadVoices:()=>{try{return b(V)}catch(e){return g.logError("Load Voices",e),!1}},changeVoice:t=>{try{const r=i(t);if(!r)return console.warn("Invalid voice change event"),!1;const n=o(r.target.value);return n?((t,r)=>{try{const n=i(r);if(!n)return g.logError("Change Voice",new Error("Invalid event object")),!1;const s=o(n.target.value);if(!s)return g.logError("Change Voice",new Error("Invalid voice URI")),!1;window.speechSynthesis.cancel();const c=e();c&&(c.isPlaying=!1);const a=f(s,t.voices);if(!a)return g.logError("Change Voice",new Error("Voice not found in available voices")),!1;t.currentVoice=a;const u=`mosne-tts-lang-${w()}`;return l(u,a.voiceURI)||g.logError("Change Voice",new Error("Failed to save voice to localStorage")),!0}catch(e){return g.logError("Change Voice",e),!1}})(V,{target:{value:n}}):(console.warn("Invalid voice URI"),!1)}catch(e){return g.logError("Change Voice",e),!1}},createUtterance:()=>{try{return x(V)}catch(e){return g.logError("Create Utterance",e),!1}},setupUtteranceEvents:()=>{try{return A(V)}catch(e){return g.logError("Setup Utterance Events",e),!1}},handleUtteranceEnd:()=>{try{return _(V)}catch(e){return g.logError("Handle Utterance End",e),!1}},Play:()=>{try{return(async t=>{const n=e();if(n&&(n.isPlaying=!0),t.isPlaying=!0,"firefox"===t.browserType&&t.pausedAt){const e=t.pausedAt.text.substring(t.pausedAt.charIndex);t.currentChunk=t.pausedAt.chunk;const n=new window.SpeechSynthesisUtterance(e);if(n.lang=w(),n.rate=t.currentSpeed,n.pitch=t.currentPitch,n._lastCharIndex=0,n._contentOffset=t.pausedAt.contentPosition,t.currentVoice){const e=t.voices.find(e=>e.voiceURI===t.currentVoice.voiceURI);n.voice=e}return n.onboundary=e=>{n._lastCharIndex=e.charIndex||0;const o=(e.charIndex||0)+t.pausedAt.contentPosition,s={...e,charIndex:o,charLength:e.charLength||1},i=S();if(i){const e=E(),n=e?.dataset.excludeClass||r;0===t.nodePositions.size&&k(t,i,n.split(/\s+/)),P(t,s,t.pausedAt.fullText||t.pausedAt.text)}},n.onend=()=>_(t),t.utterance=n,window.speechSynthesis.speak(t.utterance),"safari"===t.browserType&&I(t),void(t.pausedAt=null)}0!==t.textChunks.length&&0!==t.currentChunk||(R(t),x(t,n));try{if(window.speechSynthesis.paused)return void window.speechSynthesis.resume()}catch(e){console.warn("Resume failed, recreating speech:",e),x(t,n)}if(("chrome"===t.browserType||"edge"===t.browserType)&&window.speechSynthesis.speaking)return window.speechSynthesis.cancel(),void setTimeout(()=>{t.utterance&&window.speechSynthesis.speak(t.utterance)},50);t.utterance&&(window.speechSynthesis.speak(t.utterance),"safari"===t.browserType&&I(t))})(V)}catch(e){return g.logError("Play Action",e),!1}},Pause:()=>{try{return(async t=>{const r=e();if(r&&(r.isPlaying=!1),t.isPlaying=!1,T(t),"firefox"===t.browserType){if(window.speechSynthesis.speaking){const e=t.textChunks.join(" ");t.pausedAt={text:t.utterance.text,charIndex:t.utterance._lastCharIndex||0,chunk:t.currentChunk,contentPosition:t.utterance._lastCharIndex+(t.currentChunk>0?t.textChunks.slice(0,t.currentChunk).reduce((e,t)=>e+t.length,0):0),fullText:e},window.speechSynthesis.cancel()}}else if("safari"===t.browserType){if(window.speechSynthesis.speaking){const e=t.textChunks.join(" ");t.pausedAt={text:t.utterance.text,charIndex:t.utterance._lastCharIndex||0,chunk:t.currentChunk,contentPosition:t.utterance._lastCharIndex+(t.currentChunk>0?t.textChunks.slice(0,t.currentChunk).reduce((e,t)=>e+t.length,0):0),fullText:e},t.utterance._safariTimerId&&clearInterval(t.utterance._safariTimerId),t.safariKeepAliveTimer&&(clearInterval(t.safariKeepAliveTimer),t.safariKeepAliveTimer=null),window.speechSynthesis.cancel()}}else window.speechSynthesis.speaking&&!window.speechSynthesis.paused&&window.speechSynthesis.pause()})(V)}catch(e){return g.logError("Pause Action",e),!1}},Restart:()=>{try{return(t=>{const r=e();r&&(r.isPlaying=!1),t.isPlaying=!1,"safari"===t.browserType&&(t.utterance&&t.utterance._safariTimerId&&clearInterval(t.utterance._safariTimerId),t.safariKeepAliveTimer&&(clearInterval(t.safariKeepAliveTimer),t.safariKeepAliveTimer=null)),window.speechSynthesis.cancel(),t.currentChunk=0,t.textChunks=[],T(t)})(V)}catch(e){return g.logError("Restart Action",e),!1}},changeSpeed:t=>{try{const r=i(t);if(!r)return console.warn("Invalid speed change event"),!1;const n=d(r.target.value);if(null===n)return console.warn("Invalid speed value:",r.target.value),!1;const o={target:{value:n.toString()}};return(async(t,r)=>{try{const n=i(r);if(!n)return g.logError("Change Speed",new Error("Invalid event object")),!1;const o=d(n.target.value);if(null===o)return g.logError("Change Speed",new Error("Invalid speed value")),!1;window.speechSynthesis.cancel();const s=e();s&&(s.isPlaying=!1),t.currentSpeed=o;const c=`mosne-tts-speed-${w()}`;return l(c,o.toString())||g.logError("Change Speed",new Error("Failed to save speed to localStorage")),await C(),x(t,s),s&&!s.isPlaying&&setTimeout(()=>{s.isPlaying=!0,window.speechSynthesis.speak(t.utterance)},50),!0}catch(e){return g.logError("Change Speed",e),!1}})(V,o)}catch(e){return g.logError("Change Speed",e),!1}},changePitch:t=>{try{const r=i(t);if(!r)return console.warn("Invalid pitch change event"),!1;const n=p(r.target.value);if(null===n)return console.warn("Invalid pitch value:",r.target.value),!1;const o={target:{value:n.toString()}};return(async(t,r)=>{try{const n=i(r);if(!n)return g.logError("Change Pitch",new Error("Invalid event object")),!1;const o=p(n.target.value);if(null===o)return g.logError("Change Pitch",new Error("Invalid pitch value")),!1;window.speechSynthesis.cancel();const s=e();s&&(s.isPlaying=!1),t.currentPitch=o;const c=`mosne-tts-pitch-${w()}`;return l(c,o.toString())||g.logError("Change Pitch",new Error("Failed to save pitch to localStorage")),await C(),x(t,s),s&&!s.isPlaying&&setTimeout(()=>{s.isPlaying=!0,window.speechSynthesis.speak(t.utterance)},50),!0}catch(e){return g.logError("Change Pitch",e),!1}})(V,o)}catch(e){return g.logError("Change Pitch",e),!1}},toggleSettings:()=>{try{return(()=>{try{const t=e();return t&&(t.showSettings=!t.showSettings),!0}catch(e){return g.logError("Toggle Settings",e),!1}})()}catch(e){return g.logError("Toggle Settings",e),!1}},getContent:()=>{try{return R(V)}catch(e){return g.logError("Get Content",e),!1}}},callbacks:{init:()=>{try{return(e=>{try{if(!window.speechSynthesis)return g.logError("Init Callback",new Error("Speech synthesis not supported in this browser")),!1;window.speechSynthesis.cancel();const t=(()=>{try{const e=S(),t=E();if(!e||!t)return g.logError("Init Highlight Colors",new Error("Required elements not found")),!1;const r=t.dataset.highlightBackground||"#ffeb3b",n=t.dataset.highlightColor||"#000000",o=a(r),s=a(n),i=u(e,"--mosne-tts-highlight-bg",o),c=u(e,"--mosne-tts-highlight-color",s);return i&&c}catch(e){return g.logError("Init Highlight Colors",e),!1}})();t||g.logError("Init Callback",new Error("Failed to initialize highlight colors")),b(e)||g.logError("Init Callback",new Error("Failed to load voices")),void 0!==window.speechSynthesis.onvoiceschanged&&(window.speechSynthesis.onvoiceschanged=()=>{try{b(e)}catch(e){g.logError("Voices Changed Event",e)}}),window.addEventListener("beforeunload",()=>{try{window.speechSynthesis.cancel(),"safari"===e.browserType&&(e.utterance&&e.utterance._safariTimerId&&clearInterval(e.utterance._safariTimerId),e.safariKeepAliveTimer&&clearInterval(e.safariKeepAliveTimer))}catch(e){g.logError("Before Unload Event",e)}});const n=S();if(n){const t=E(),o=(t?.dataset.excludeClass||r).split(/\s+/).filter(e=>e.trim());setTimeout(()=>{try{k(e,n,o)}catch(e){g.logError("Build Node Positions Map",e)}},500)}return!0}catch(e){return g.logError("Init Callback",e),!1}})(V)}catch(e){return g.logError("Init Callback",e),!1}},isSelected:()=>{try{return(t=>{try{const r=e();return!(!r||!t)&&r.voice?.voiceURI===t.currentVoice?.voiceURI}catch(e){return g.logError("Is Selected Callback",e),!1}})(V)}catch(e){return g.logError("Is Selected Callback",e),!1}}}});var U;