import*as e from"@wordpress/interactivity";var t={d:(e,n)=>{for(var s in n)t.o(n,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const n=(C={getContext:()=>e.getContext,store:()=>e.store},k={},t.d(k,C),k),s="skip-speech",r=(e,t)=>{try{return window.localStorage.getItem(e)||t}catch(e){return t}},i=()=>document.documentElement.lang||"en",o=()=>document.querySelector('[data-wp-interactive="mosne-text-to-speech-block"]'),c=()=>document.querySelector("main"),a={isPlaying:!1,currentVoice:null,preferredVoice:r(`mosne-tts-lang-${i()}`,null),utterance:null,voices:[],currentSpeed:r((T=i(),`mosne-tts-speed-${T}`),1),currentPitch:r((e=>`mosne-tts-pitch-${e}`)(i()),1),selectedTextRange:{hasSelection:!1},currentChunk:0,textChunks:[],isProcessingChunks:!1,currentHighlightedNode:null,nodePositions:new Map,currentSelection:null,pausedAt:null,browserType:(()=>{const e=window.navigator.userAgent;return-1!==e.indexOf("Firefox")?"firefox":-1!==e.indexOf("Edge")||-1!==e.indexOf("Edg")?"edge":-1!==e.indexOf("Safari")&&-1===e.indexOf("Chrome")?"safari":-1!==e.indexOf("Chrome")?"chrome":"other"})(),safariKeepAliveTimer:null},l=()=>new Promise((e=>{const t=()=>{window.speechSynthesis.speaking||window.speechSynthesis.pending?setTimeout(t,100):e()};t()})),h=e=>{"safari"===e.browserType&&(e.safariKeepAliveTimer&&clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=setInterval((()=>{e.isPlaying&&window.speechSynthesis.speaking?(window.speechSynthesis.pause(),window.speechSynthesis.resume()):(clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=null)}),1e4))},u=e=>{if(e.currentSelection){try{e.currentSelection.removeAllRanges()}catch(e){console.warn("Error clearing highlights:",e)}e.currentSelection=null}e.currentHighlightedNode=null},d=(e,t)=>{if("safari"!==e.browserType)return null;const n=15*e.currentSpeed;let s=0;const r=setInterval((()=>{e.isPlaying?(g(e,{charIndex:s,charLength:1},t),s+=Math.ceil(250*n/1e3)):clearInterval(r)}),250);return r},g=(e,t)=>{const n=c();if(n)try{let r=t.charIndex;if(e.currentChunk>0)for(let t=0;t<e.currentChunk;t++)r+=e.textChunks[t].length+1;if(e.selectedTextRange?.hasSelection);else{const t=o(),i=(t?.dataset.excludeClass||s).split(/\s+/);0===e.nodePositions.size&&p(e,n,i);let c=null,a={node:null,distance:Number.MAX_SAFE_INTEGER};const l=Array.from(e.nodePositions.keys()).sort(((e,t)=>e-t));for(let t=0;t<l.length;t++){const n=l[t],s=e.nodePositions.get(n);if(n<=r&&r<n+s.length){c=s.node;break}if("firefox"===e.browserType){const e=Math.abs(n-r);e<a.distance&&(a={node:s.node,distance:e})}}!c&&"firefox"===e.browserType&&a.node&&(c=a.node),c&&c!==e.currentHighlightedNode&&c.textContent.trim().length>0&&(u(e),((e,t)=>{if(!t)return null;const n=t.ownerDocument,s=n.defaultView;if(!s)return null;u(e);try{const r=n.createRange();t.nodeType===Node.TEXT_NODE?(r.setStart(t,0),r.setEnd(t,t.length)):r.selectNodeContents(t);const i=s.getSelection();i&&(i.removeAllRanges(),i.addRange(r),e.currentSelection=i,i.rangeCount>0&&(i.getRangeAt(0),i.getRangeAt(0)))}catch(e){console.warn("Error creating highlight:",e)}})(e,c),e.currentHighlightedNode=c,c.nodeType!==Node.TEXT_NODE?c.scrollIntoView({behavior:"smooth",block:"center"}):c.parentNode&&c.parentNode.scrollIntoView({behavior:"smooth",block:"center"}))}}catch(e){console.error("Highlighting error:",e)}},p=(e,t,n)=>{e.nodePositions.clear();const s=(t,r=0)=>{if(t.classList)for(const e of n)if(e&&t.classList.contains(e))return r;if(t.nodeType===Node.TEXT_NODE){const n=t.textContent;return n.trim().length>0&&(e.nodePositions.set(r,{node:t,length:n.length}),r+=n.length),r}if(t.childNodes&&t.childNodes.length>0)for(const e of t.childNodes)r=s(e,r);return r};s(t)},w=(e,t)=>{const n=e.textChunks[e.currentChunk],s=new window.SpeechSynthesisUtterance(n);if(s.lang=i(),s.rate=e.currentSpeed,s.pitch=e.currentPitch,e.currentVoice){const t=e.voices.find((t=>t.voiceURI===e.currentVoice.voiceURI));s.voice=t}f(e,s,n,t),e.utterance=s},f=(e,t,n,s)=>{"safari"===e.browserType?(t.onboundary=s=>{t._lastCharIndex=s.charIndex||0,g(e,s,n)},t._safariTimerId=d(e,n)):t.onboundary=s=>{t._lastCharIndex=s.charIndex||0;const r=void 0!==t._contentOffset?{...s,charIndex:(s.charIndex||0)+t._contentOffset}:s;g(e,r,n)},t.onend=()=>{t._safariTimerId&&clearInterval(t._safariTimerId),e.currentChunk<e.textChunks.length-1?(e.currentChunk++,w(e,s),setTimeout((()=>{e.isPlaying&&e.utterance&&window.speechSynthesis.speak(e.utterance)}),50)):(s&&(s.isPlaying=!1),e.isPlaying=!1,u(e))},t.onerror=t=>{console.error("Speech synthesis error:",t),"interrupted"===t.error&&(speechSynthesis.cancel(),y(e))}},y=e=>{u(e),e.isPlaying=!1,e.currentChunk=0,e.textChunks=[],e.currentHighlightedNode=null,e.selectedTextRange={hasSelection:!1}},m=async e=>{"safari"===e.browserType&&(window.speechSynthesis.speak(new SpeechSynthesisUtterance("")),window.speechSynthesis.cancel());const t=window.speechSynthesis.getVoices();if(!t?.length)return void setTimeout((()=>m(e)),100);const n=i(),s=t.filter((e=>e.lang.startsWith(n)));if(e.voices=s.length>0?s:t,e.currentVoice=e.voices[0],e.preferredVoice){const t=e.voices.find((t=>t.voiceURI===e.preferredVoice));t&&(e.currentVoice=t)}setTimeout((()=>w(e)),50)},x=e=>{const t=c(),n=t?.ownerDocument.defaultView,r=n?n.getSelection():null;let i="";if(r&&r.toString().trim().length>0)i=r.toString(),e.selectedTextRange={text:i,hasSelection:!0};else{let n=t?.cloneNode(!0);if(n){const r=o(),c=r?.dataset.excludeClass||s;c.split(/\s+/).forEach((e=>{e&&n.querySelectorAll(`.${e}`).forEach((e=>{e.remove()}))})),i=n.textContent,n=null,t&&p(e,t,c.split(/\s+/))}e.selectedTextRange={hasSelection:!1}}return e.textChunks=S(i,200),e.currentChunk=0,e.textChunks.length>0?e.textChunks[0]:""},S=(e,t)=>{if(!e||""===e.trim())return[""];const n=e.trim().split(/\s+/),s=[];for(let e=0;e<n.length;e+=t){const r=n.slice(e,e+t).join(" ");s.push(r)}return s},{state:v}=(0,n.store)("mosne-text-to-speech-block",{state:a,actions:{checkSynthesisReady:()=>l(),setupSafariKeepAlive:()=>h(v),buildNodePositionsMap:()=>p(v),handleBoundaryEvent:()=>g(v),setupSafariHighlighting:()=>d(v),clearHighlights:()=>u(v),loadVoices:()=>m(v),changeVoice:e=>((e,t)=>{window.speechSynthesis.cancel();const s=(0,n.getContext)();s&&(s.isPlaying=!1);const r=e.voices.find((e=>e.voiceURI===t.target.value));r&&(e.currentVoice=r,window.localStorage.setItem("mosne-tts-lang-"+document.documentElement.lang,r.voiceURI))})(v,e),createUtterance:()=>w(v),setupUtteranceEvents:()=>f(v),handleUtteranceEnd:()=>y(v),Play:()=>(async e=>{const t=(0,n.getContext)();if(t&&(t.isPlaying=!0),e.isPlaying=!0,"firefox"===e.browserType&&e.pausedAt){const t=e.pausedAt.text.substring(e.pausedAt.charIndex);e.currentChunk=e.pausedAt.chunk;const n=new window.SpeechSynthesisUtterance(t);if(n.lang=i(),n.rate=e.currentSpeed,n.pitch=e.currentPitch,n._lastCharIndex=0,n._contentOffset=e.pausedAt.contentPosition,e.currentVoice){const t=e.voices.find((t=>t.voiceURI===e.currentVoice.voiceURI));n.voice=t}return n.onboundary=t=>{n._lastCharIndex=t.charIndex||0;const r=(t.charIndex||0)+e.pausedAt.contentPosition,i={...t,charIndex:r,charLength:t.charLength||1},a=c();if(a){const t=o(),n=t?.dataset.excludeClass||s;0===e.nodePositions.size&&p(e,a,n.split(/\s+/)),g(e,i,e.pausedAt.fullText||e.pausedAt.text)}},n.onend=()=>y(e),e.utterance=n,window.speechSynthesis.speak(e.utterance),"safari"===e.browserType&&h(e),void(e.pausedAt=null)}0!==e.textChunks.length&&0!==e.currentChunk||(x(e),w(e,t));try{if(window.speechSynthesis.paused)return void window.speechSynthesis.resume()}catch(n){console.warn("Resume failed, recreating speech:",n),w(e,t)}if(("chrome"===e.browserType||"edge"===e.browserType)&&window.speechSynthesis.speaking)return window.speechSynthesis.cancel(),void setTimeout((()=>{e.utterance&&window.speechSynthesis.speak(e.utterance)}),50);e.utterance&&(window.speechSynthesis.speak(e.utterance),"safari"===e.browserType&&h(e))})(v),Pause:()=>(async e=>{const t=(0,n.getContext)();if(t&&(t.isPlaying=!1),e.isPlaying=!1,u(e),"firefox"===e.browserType){if(window.speechSynthesis.speaking){const t=e.textChunks.join(" ");e.pausedAt={text:e.utterance.text,charIndex:e.utterance._lastCharIndex||0,chunk:e.currentChunk,contentPosition:e.utterance._lastCharIndex+(e.currentChunk>0?e.textChunks.slice(0,e.currentChunk).reduce(((e,t)=>e+t.length),0):0),fullText:t},window.speechSynthesis.cancel()}}else if("safari"===e.browserType){if(window.speechSynthesis.speaking){const t=e.textChunks.join(" ");e.pausedAt={text:e.utterance.text,charIndex:e.utterance._lastCharIndex||0,chunk:e.currentChunk,contentPosition:e.utterance._lastCharIndex+(e.currentChunk>0?e.textChunks.slice(0,e.currentChunk).reduce(((e,t)=>e+t.length),0):0),fullText:t},e.utterance._safariTimerId&&clearInterval(e.utterance._safariTimerId),e.safariKeepAliveTimer&&(clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=null),window.speechSynthesis.cancel()}}else window.speechSynthesis.speaking&&!window.speechSynthesis.paused&&window.speechSynthesis.pause()})(v),Restart:()=>(e=>{const t=(0,n.getContext)();t&&(t.isPlaying=!1),e.isPlaying=!1,"safari"===e.browserType&&(e.utterance&&e.utterance._safariTimerId&&clearInterval(e.utterance._safariTimerId),e.safariKeepAliveTimer&&(clearInterval(e.safariKeepAliveTimer),e.safariKeepAliveTimer=null)),window.speechSynthesis.cancel(),e.currentChunk=0,e.textChunks=[],u(e)})(v),changeSpeed:e=>(async(e,t)=>{window.speechSynthesis.cancel();const s=(0,n.getContext)();s&&(s.isPlaying=!1),e.currentSpeed=t.target.value,window.localStorage.setItem("mosne-tts-speed-"+document.documentElement.lang,t.target.value),await l(),w(e,s),s&&!s.isPlaying&&setTimeout((()=>{s.isPlaying=!0,window.speechSynthesis.speak(e.utterance)}),50)})(v,e),changePitch:e=>(async(e,t)=>{window.speechSynthesis.cancel();const s=(0,n.getContext)();s&&(s.isPlaying=!1),e.currentPitch=t.target.value,window.localStorage.setItem("mosne-tts-pitch-"+document.documentElement.lang,t.target.value),await l(),w(e,s),s&&!s.isPlaying&&setTimeout((()=>{s.isPlaying=!0,window.speechSynthesis.speak(e.utterance)}),50)})(v,e),toggleSettings:()=>(()=>{const e=(0,n.getContext)();e&&(e.showSettings=!e.showSettings)})(),getContent:()=>x(v)},callbacks:{init:()=>(e=>{if(!window.speechSynthesis)return void console.warn("Speech synthesis not supported in this browser");window.speechSynthesis.cancel(),(()=>{const e=c(),t=o();if(!e||!t)return;const n=t.dataset.highlightBackground||"#ffeb3b",s=t.dataset.highlightColor||"#000000";e.style.setProperty("--mosne-tts-highlight-bg",n),e.style.setProperty("--mosne-tts-highlight-color",s)})(),m(e),void 0!==window.speechSynthesis.onvoiceschanged&&(window.speechSynthesis.onvoiceschanged=()=>m(e)),window.addEventListener("beforeunload",(()=>{window.speechSynthesis.cancel(),"safari"===e.browserType&&(e.utterance&&e.utterance._safariTimerId&&clearInterval(e.utterance._safariTimerId),e.safariKeepAliveTimer&&clearInterval(e.safariKeepAliveTimer))}));const t=c();if(t){const n=o(),r=n?.dataset.excludeClass||s;setTimeout((()=>{p(e,t,r.split(/\s+/))}),500)}})(v),isSelected:()=>(e=>{const t=(0,n.getContext)();return t.voice?.voiceURI===e.currentVoice?.voiceURI})(v)}});var T,C,k;