import*as e from"@wordpress/interactivity";var t={d:(e,n)=>{for(var s in n)t.o(n,s)&&!t.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:n[s]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t)};const n=(g={getContext:()=>e.getContext,store:()=>e.store},p={},t.d(p,g),p),s="skip-speech",r=(e,t)=>{try{return window.localStorage.getItem(e)||t}catch(e){return t}},i=()=>document.documentElement.lang||"en",o=()=>document.querySelector('[data-wp-interactive="mosne-text-to-speech-block"]'),a=()=>document.querySelector("main"),c=()=>{const e=window.navigator.userAgent;return-1!==e.indexOf("Firefox")?"firefox":-1!==e.indexOf("Edge")||-1!==e.indexOf("Edg")?"edge":-1!==e.indexOf("Safari")&&-1===e.indexOf("Chrome")?"safari":-1!==e.indexOf("Chrome")?"chrome":"other"},{state:l,actions:h}=(0,n.store)("mosne-text-to-speech-block",{state:{isPlaying:!1,currentVoice:null,preferredVoice:r((u=i(),`mosne-tts-lang-${u}`),null),utterance:null,voices:[],currentSpeed:r((e=>`mosne-tts-speed-${e}`)(i()),1),currentPitch:r((e=>`mosne-tts-pitch-${e}`)(i()),1),selectedTextRange:{hasSelection:!1},currentChunk:0,textChunks:[],isProcessingChunks:!1,currentHighlightedNode:null,nodePositions:new Map,currentSelection:null,pausedAt:null,browserType:c(),safariKeepAliveTimer:null},actions:{checkSynthesisReady:()=>new Promise((e=>{const t=()=>{window.speechSynthesis.speaking||window.speechSynthesis.pending?setTimeout(t,100):e()};t()})),clearHighlights(){if(l.currentSelection){try{l.currentSelection.removeAllRanges()}catch(e){console.warn("Error clearing highlights:",e)}l.currentSelection=null}l.currentHighlightedNode=null},createHighlightWrapper(e){if(!e)return null;const t=e.ownerDocument,n=t.defaultView;if(!n)return null;h.clearHighlights();try{const s=t.createRange();e.nodeType===Node.TEXT_NODE?(s.setStart(e,0),s.setEnd(e,e.length)):s.selectNodeContents(e);const r=n.getSelection();r&&(r.removeAllRanges(),r.addRange(s),l.currentSelection=r,r.rangeCount>0&&(r.getRangeAt(0),r.getRangeAt(0)))}catch(e){console.warn("Error creating highlight:",e)}},async loadVoices(){"safari"===l.browserType&&(window.speechSynthesis.speak(new SpeechSynthesisUtterance("")),window.speechSynthesis.cancel());const e=window.speechSynthesis.getVoices();if(!e?.length)return void setTimeout((()=>h.loadVoices()),100);const t=i(),n=e.filter((e=>e.lang.startsWith(t)));if(l.voices=n.length>0?n:e,l.currentVoice=l.voices[0],l.preferredVoice){const e=l.voices.find((e=>e.voiceURI===l.preferredVoice));e&&(l.currentVoice=e)}setTimeout((()=>h.createUtterance()),50)},createUtterance(){const e=l.textChunks[l.currentChunk],t=new window.SpeechSynthesisUtterance(e);if(t.lang=i(),t.rate=l.currentSpeed,t.pitch=l.currentPitch,l.currentVoice){const e=l.voices.find((e=>e.voiceURI===l.currentVoice.voiceURI));t.voice=e}h.setupUtteranceEvents(t,e),l.utterance=t},setupUtteranceEvents(e,t){"safari"===l.browserType?(e.onboundary=n=>{e._lastCharIndex=n.charIndex||0,h.handleBoundaryEvent(n,t)},e._safariTimerId=h.setupSafariHighlighting(t)):e.onboundary=n=>{e._lastCharIndex=n.charIndex||0;const s=void 0!==e._contentOffset?{...n,charIndex:(n.charIndex||0)+e._contentOffset}:n;h.handleBoundaryEvent(s,t)},e.onend=()=>{if(e._safariTimerId&&clearInterval(e._safariTimerId),l.currentChunk<l.textChunks.length-1)return l.currentChunk++,h.createUtterance(),void setTimeout((()=>{l.isPlaying&&l.utterance&&window.speechSynthesis.speak(l.utterance)}),50);l.isPlaying=!1,l.currentChunk=0,l.textChunks=[],l.currentHighlightedNode=null,l.selectedTextRange={hasSelection:!1}},e.onerror=e=>{console.error("Speech synthesis error:",e),h.handleUtteranceEnd()}},setupSafariHighlighting(e){if("safari"!==l.browserType)return null;const t=15*l.currentSpeed;let n=0;const s=setInterval((()=>{if(!l.isPlaying)return void clearInterval(s);const r={charIndex:n,charLength:1};h.handleBoundaryEvent(r,e),n+=Math.ceil(250*t/1e3)}),250);return s},setupSafariKeepAlive(){"safari"===l.browserType&&(l.safariKeepAliveTimer&&clearInterval(l.safariKeepAliveTimer),l.safariKeepAliveTimer=setInterval((()=>{l.isPlaying&&window.speechSynthesis.speaking?(window.speechSynthesis.pause(),window.speechSynthesis.resume()):(clearInterval(l.safariKeepAliveTimer),l.safariKeepAliveTimer=null)}),1e4))},async Play(){if((0,n.getContext)().isPlaying=!0,l.isPlaying=!0,"firefox"===l.browserType&&l.pausedAt){const e=l.pausedAt.text.substring(l.pausedAt.charIndex);l.currentChunk=l.pausedAt.chunk;const t=new window.SpeechSynthesisUtterance(e);if(t.lang=i(),t.rate=l.currentSpeed,t.pitch=l.currentPitch,t._lastCharIndex=0,t._contentOffset=l.pausedAt.contentPosition,l.currentVoice){const e=l.voices.find((e=>e.voiceURI===l.currentVoice.voiceURI));t.voice=e}return t.onboundary=e=>{t._lastCharIndex=e.charIndex||0;const n=(e.charIndex||0)+l.pausedAt.contentPosition,r={...e,charIndex:n,charLength:e.charLength||1},i=a();if(i){const e=o(),t=e?.dataset.excludeClass||s;0===l.nodePositions.size&&h.buildNodePositionsMap(i,t.split(/\s+/)),h.handleBoundaryEvent(r,l.pausedAt.fullText||l.pausedAt.text)}},t.onend=()=>h.handleUtteranceEnd(),l.utterance=t,window.speechSynthesis.speak(l.utterance),"safari"===l.browserType&&h.setupSafariKeepAlive(),void(l.pausedAt=null)}0!==l.textChunks.length&&0!==l.currentChunk||(h.getContent(),h.createUtterance());try{if(window.speechSynthesis.paused)return void window.speechSynthesis.resume()}catch(e){console.warn("Resume failed, recreating speech:",e),h.createUtterance()}if(("chrome"===l.browserType||"edge"===l.browserType)&&window.speechSynthesis.speaking)return window.speechSynthesis.cancel(),void setTimeout((()=>{l.utterance&&window.speechSynthesis.speak(l.utterance)}),50);l.utterance&&(window.speechSynthesis.speak(l.utterance),"safari"===l.browserType&&h.setupSafariKeepAlive())},Pause(){if((0,n.getContext)().isPlaying=!1,l.isPlaying=!1,"firefox"===l.browserType){if(window.speechSynthesis.speaking){const e=l.textChunks.join(" ");l.pausedAt={text:l.utterance.text,charIndex:l.utterance._lastCharIndex||0,chunk:l.currentChunk,contentPosition:l.utterance._lastCharIndex+(l.currentChunk>0?l.textChunks.slice(0,l.currentChunk).reduce(((e,t)=>e+t.length),0):0),fullText:e},window.speechSynthesis.cancel()}}else if("safari"===l.browserType){if(window.speechSynthesis.speaking){const e=l.textChunks.join(" ");l.pausedAt={text:l.utterance.text,charIndex:l.utterance._lastCharIndex||0,chunk:l.currentChunk,contentPosition:l.utterance._lastCharIndex+(l.currentChunk>0?l.textChunks.slice(0,l.currentChunk).reduce(((e,t)=>e+t.length),0):0),fullText:e},l.utterance._safariTimerId&&clearInterval(l.utterance._safariTimerId),l.safariKeepAliveTimer&&(clearInterval(l.safariKeepAliveTimer),l.safariKeepAliveTimer=null),window.speechSynthesis.cancel()}}else window.speechSynthesis.speaking&&!window.speechSynthesis.paused&&window.speechSynthesis.pause()},Restart(){(0,n.getContext)().isPlaying=!1,l.isPlaying=!1,"safari"===l.browserType&&(l.utterance&&l.utterance._safariTimerId&&clearInterval(l.utterance._safariTimerId),l.safariKeepAliveTimer&&(clearInterval(l.safariKeepAliveTimer),l.safariKeepAliveTimer=null)),window.speechSynthesis.cancel(),l.currentChunk=0,l.textChunks=[],h.clearHighlights()},changeVoice(e){(0,n.getContext)().isPlaying=!1,window.speechSynthesis.cancel();const t=l.voices.find((t=>t.voiceURI===e.target.value));t&&(l.currentVoice=t,window.localStorage.setItem("mosne-tts-lang-"+document.documentElement.lang,t.voiceURI),setTimeout((()=>{h.updateUtterance()}),50))},async changeSpeed(e){const t=(0,n.getContext)();t.isPlaying=!1,window.speechSynthesis.cancel(),l.currentSpeed=e.target.value,window.localStorage.setItem("mosne-tts-speed-"+document.documentElement.lang,e.target.value),await h.checkSynthesisReady(),h.createUtterance(),t.isPlaying&&setTimeout((()=>{window.speechSynthesis.speak(l.utterance)}),50)},async changePitch(e){const t=(0,n.getContext)();t.isPlaying=!1,window.speechSynthesis.cancel(),l.currentPitch=e.target.value,window.localStorage.setItem("mosne-tts-pitch-"+document.documentElement.lang,e.target.value),await h.checkSynthesisReady(),h.createUtterance(),t.isPlaying&&setTimeout((()=>{window.speechSynthesis.speak(l.utterance)}),50)},toggleSettings(){const e=(0,n.getContext)();e.showSettings=!e.showSettings},getContent(){const e=a(),t=e?.ownerDocument.defaultView,n=t?t.getSelection():null;let r="";if(n&&n.toString().trim().length>0)r=n.toString(),l.selectedTextRange={text:r,hasSelection:!0};else{let t=e?.cloneNode(!0);if(t){const n=o(),i=n?.dataset.excludeClass||s;i.split(/\s+/).forEach((e=>{e&&t.querySelectorAll(`.${e}`).forEach((e=>{e.remove()}))})),r=t.textContent,t=null,e&&h.buildNodePositionsMap(e,i.split(/\s+/))}l.selectedTextRange={hasSelection:!1}}return l.textChunks=h.chunkText(r,200),l.currentChunk=0,l.textChunks.length>0?l.textChunks[0]:""},chunkText(e,t){if(!e||""===e.trim())return[""];const n=e.trim().split(/\s+/),s=[];for(let e=0;e<n.length;e+=t){const r=n.slice(e,e+t).join(" ");s.push(r)}return s},handleBoundaryEvent(e,t){const n=a();if(n)try{let t=e.charIndex;if(l.currentChunk>0)for(let e=0;e<l.currentChunk;e++)t+=l.textChunks[e].length+1;if(l.selectedTextRange?.hasSelection);else{const e=o(),r=(e?.dataset.excludeClass||s).split(/\s+/);0===l.nodePositions.size&&h.buildNodePositionsMap(n,r);let i=null,a={node:null,distance:Number.MAX_SAFE_INTEGER};const c=Array.from(l.nodePositions.keys()).sort(((e,t)=>e-t));for(let e=0;e<c.length;e++){const n=c[e],s=l.nodePositions.get(n);if(n<=t&&t<n+s.length){i=s.node;break}if("firefox"===l.browserType){const e=Math.abs(n-t);e<a.distance&&(a={node:s.node,distance:e})}}!i&&"firefox"===l.browserType&&a.node&&(i=a.node),i&&i!==l.currentHighlightedNode&&i.textContent.trim().length>0&&(h.clearHighlights(),h.createHighlightWrapper(i),l.currentHighlightedNode=i,i.nodeType!==Node.TEXT_NODE?i.scrollIntoView({behavior:"smooth",block:"center"}):i.parentNode&&i.parentNode.scrollIntoView({behavior:"smooth",block:"center"}))}}catch(e){console.error("Highlighting error:",e)}},handleUtteranceEnd(){h.clearHighlights(),(0,n.getContext)().isPlaying=!1,l.isPlaying=!1,l.currentChunk=0,l.textChunks=[],l.currentHighlightedNode=null,l.selectedTextRange={hasSelection:!1}},buildNodePositionsMap(e,t){l.nodePositions.clear();const n=(e,s=0)=>{if(e.classList)for(const n of t)if(n&&e.classList.contains(n))return s;if(e.nodeType===Node.TEXT_NODE){const t=e.textContent;return t.trim().length>0&&(l.nodePositions.set(s,{node:e,length:t.length}),s+=t.length),s}if(e.childNodes&&e.childNodes.length>0)for(const t of e.childNodes)s=n(t,s);return s};n(e)}},callbacks:{init(){if(!window.speechSynthesis)return void console.warn("Speech synthesis not supported in this browser");window.speechSynthesis.cancel(),l.browserType=c(),d(),h.loadVoices(),void 0!==window.speechSynthesis.onvoiceschanged&&(window.speechSynthesis.onvoiceschanged=h.loadVoices),window.addEventListener("beforeunload",(()=>{window.speechSynthesis.cancel(),"safari"===l.browserType&&(l.utterance&&l.utterance._safariTimerId&&clearInterval(l.utterance._safariTimerId),l.safariKeepAliveTimer&&clearInterval(l.safariKeepAliveTimer))}));const e=a();if(e){const t=o(),n=t?.dataset.excludeClass||s;setTimeout((()=>{h.buildNodePositionsMap(e,n.split(/\s+/))}),500)}},isSelected:()=>(0,n.getContext)().voice.voiceURI===l.currentVoice.voiceURI}}),d=()=>{const e=a(),t=o();if(!e||!t)return;const n=t.dataset.highlightBackground||"#ffeb3b",s=t.dataset.highlightColor||"#000000";e.style.setProperty("--mosne-tts-highlight-bg",n),e.style.setProperty("--mosne-tts-highlight-color",s)};var u,g,p;